<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="لعبة ذكاء مثيرة - أبطال كيد الاعداء">
    <meta name="keywords" content="لعبة, ألغاز, ذكاء, بطاقات, تحديات">
    <meta name="author" content="أبطال كيد الاعداء">
    <title>أبطال كيد الاعداء - لعبة الذكاء المثيرة</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Toastify CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <!-- أنماط الملف الشخصي والإعدادات -->
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="settings.css">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="أبطال كيد الاعداء - لعبة الذكاء المثيرة">
    <meta name="twitter:description" content="لعبة ذكاء مثيرة مع تحديات ومراحل مختلفة">
    <meta name="twitter:image" content="https://yourdomain.com/images/og-image.jpg">
    
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="أبطال كيد الاعداء - لعبة الذكاء المثيرة">
    <meta property="og:description" content="لعبة ذكاء مثيرة مع تحديات ومراحل مختلفة">
    <meta property="og:image" content="https://yourdomain.com/images/og-image.jpg">
    <meta property="og:url" content="https://yourdomain.com">
    <meta property="og:locale" content="ar_SA">
    
    <!-- PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="أبطال البطاقات">
    
    <style>
       /* styles.css - النسخة المحسنة الكاملة */
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');

:root {
    --primary: #6c5ce7;
    --secondary: #a29bfe;
    --accent: #fd79a8;
    --success: #00b894;
    --warning: #fdcb6e;
    --danger: #d63031;
    --dark: #2d3436;
    --light: #dfe6e9;
    --gradient: linear-gradient(120deg, #6c5ce7, #fd79a8);
    --gradient-light: linear-gradient(120deg, rgba(108, 92, 231, 0.8), rgba(253, 121, 168, 0.8));
    --card-back: #6c5ce7;
    --background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    --glass-bg: rgba(255, 255, 255, 0.08);
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.36);
    --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
    font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background: var(--background);
    color: var(--light);
    line-height: 1.6;
    min-height: 100vh;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    background-attachment: fixed;
    touch-action: manipulation;
    overflow-x: hidden;
    font-size: 16px;
   padding-bottom: 80px !important;
}

/* تصميم زجاجي محسن */
.glass-effect {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(25px) saturate(180%);
    -webkit-backdrop-filter: blur(25px) saturate(180%);
    border-radius: 24px;
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
    transition: var(--transition-smooth);
}

.glass-effect-light {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
}

.glass-effect:hover {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

/* تأثيرات الانتقالات بين الشاشات */
.screen {
    display: none;
    opacity: 0;
    transform: translateX(100%);
    transition: var(--transition-smooth);
    position: absolute;
    width: 100%;
    top: 0;
    left: 0;
}

.screen.active {
    display: block;
    opacity: 1;
    transform: translateX(0);
    position: relative;
}

.screen.slide-left {
    transform: translateX(-100%);
}

.screen.slide-right {
    transform: translateX(100%);
}

.screen.fade-out {
    opacity: 0;
}

.screen.fade-in {
    opacity: 1;
}

/* شاشة التحميل */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--background);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
}

.loading-spinner {
    width: 80px;
    height: 80px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--primary);
    border-right-color: var(--accent);
    animation: spin 1.5s linear infinite;
    margin-bottom: 25px;
    position: relative;
}

.loading-spinner::after {
    content: '';
    position: absolute;
    top: -8px;
    left: -8px;
    right: -8px;
    bottom: -8px;
    border: 4px solid transparent;
    border-radius: 50%;
    border-top-color: var(--secondary);
    animation: spin 2s linear infinite reverse;
}

.loading-text {
    font-size: 20px;
    color: var(--light);
    text-align: center;
    margin-top: 20px;
    font-weight: 500;
    background: var(--gradient-light);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: pulse 2s infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 15px;
}

/* تصميم العنوان مع تأثير زجاجي محسن */
header {
    text-align: center;
    padding: 25px 20px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
    transition: var(--transition-smooth);
}

header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: var(--gradient);
    border-radius: 0 0 5px 5px;
    animation: gradientFlow 3s ease infinite;
    background-size: 200% 200%;
}

header::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.05) 50%, transparent 70%);
    animation: shimmer 3s infinite;
}

@keyframes gradientFlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

h1 {
    font-size: 32px;
    margin-bottom: 15px;
    background: var(--gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    font-weight: 800;
    letter-spacing: 0.5px;
    position: relative;
    z-index: 2;
}

.total-points {
    font-size: 22px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px 24px;
    border-radius: 50px;
    margin: 0 auto;
    max-width: 300px;
    transition: var(--transition-smooth);
}

.total-points i {
    color: var(--warning);
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.4));
    font-size: 24px;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* تصميم الخريطة التفاعلية للمراحل */
.stages-map {
    position: relative;
    min-height: 600px;
    margin: 30px auto;
    background: linear-gradient(to bottom, rgba(26, 26, 46, 0.8), rgba(22, 33, 62, 0.9));
    border-radius: 20px;
    padding: 20px;
    overflow: hidden;
}

.stages-map::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(circle at 20% 30%, rgba(108, 92, 231, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(253, 121, 168, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(0, 184, 148, 0.1) 0%, transparent 50%);
    z-index: 0;
}

.stage-connection {
    position: absolute;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--secondary), transparent);
    z-index: 1;
    transform-origin: 0 0;
}

.stage-point {
    position: absolute;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition-bounce);
    z-index: 2;
    transform-origin: center;
}

.stage-point i {
    font-size: 28px;
    margin-bottom: 8px;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
    transition: var(--transition-smooth);
}

.stage-point span {
    font-size: 16px;
    font-weight: bold;
    transition: var(--transition-smooth);
}

.stage-point.completed {
    background: linear-gradient(135deg, var(--success), #00ffaa);
    box-shadow: 
        0 8px 25px rgba(0, 184, 148, 0.4),
        inset 0 0 20px rgba(255, 255, 255, 0.2);
    animation: pulseGlow 2s infinite;
}

.stage-point.available {
    background: var(--gradient);
    box-shadow: 
        0 8px 25px rgba(108, 92, 231, 0.4),
        inset 0 0 20px rgba(255, 255, 255, 0.2);
}

.stage-point.locked {
    background: linear-gradient(135deg, rgba(99, 110, 114, 0.5), rgba(99, 110, 114, 0.3));
    cursor: not-allowed;
    filter: grayscale(0.7) brightness(0.7);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.stage-point:hover:not(.locked) {
    transform: scale(1.2) translateY(-8px);
    box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.4),
        inset 0 0 30px rgba(255, 255, 255, 0.3);
}

.stage-point:hover:not(.locked) i {
    transform: scale(1.2) rotate(10deg);
}

.stage-point:hover:not(.locked) span {
    transform: scale(1.1);
}

@keyframes pulseGlow {
    0%, 100% { 
        box-shadow: 
            0 8px 25px rgba(0, 184, 148, 0.4),
            inset 0 0 20px rgba(255, 255, 255, 0.2);
    }
    50% { 
        box-shadow: 
            0 8px 35px rgba(0, 184, 148, 0.6),
            inset 0 0 25px rgba(255, 255, 255, 0.3);
    }
}

/* تصميم المستويات */
.levels-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

.level-card {
    aspect-ratio: 1;
    border-radius: 20px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: var(--transition-bounce);
}

.level-card .level-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    opacity: 0.4;
    z-index: 1;
    transition: var(--transition-smooth);
}

.level-card .level-number {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 10px;
    color: var(--light);
    z-index: 2;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

.level-card .level-status {
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    z-index: 2;
    color: var(--light);
    text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
}

.level-card.completed {
    box-shadow: 0 0 30px rgba(0, 184, 148, 0.3);
}

.level-card.completed .level-bg {
    opacity: 0.6;
}

.level-card.locked {
    filter: grayscale(0.8) brightness(0.6);
    cursor: not-allowed;
}

.level-card:hover:not(.locked) {
    transform: translateY(-10px) scale(1.05);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.level-card:hover:not(.locked) .level-bg {
    opacity: 0.7;
    transform: scale(1.1);
}

/* تصميم البطاقات مع تأثيرات محسنة */
.cards-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-top: 25px;
}

.cards-section {
    padding: 25px;
    margin-bottom: 15px;
}

.cards-section h2 {
    margin-bottom: 20px;
    text-align: center;
    color: var(--secondary);
    font-size: 22px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.cards-section h2 i {
    font-size: 24px;
    animation: float 3s ease-in-out infinite;
}

.app-cards, .player-cards {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    padding: 15px;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.card {
    width: 140px;
    height: 200px;
    perspective: 1200px;
    cursor: pointer;
    transition: var(--transition-smooth);
    position: relative;
}

.card:hover {
    transform: translateY(-10px) rotateX(5deg);
}

.card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    transform-style: preserve-3d;
    border-radius: 20px;
    box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
   
}

.card.flipped .card-inner {
    transform: rotateY(180deg);
}

.card-front, .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    padding: 1px;
}

.card-front {
    background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%);
    color: var(--dark);
    transform: rotateY(180deg);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.card-front img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 15px;
    transition: var(--transition-smooth);
}

.card-front:hover img {
    transform: none;
}

.card-back {
    background: var(--gradient);
    color: white;
    font-size: 32px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background-image: 
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><path fill="rgba(255,255,255,0.15)" d="M0 0h20v20H0zM20 20h20v20H20z"/></svg>'),
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    background-size: 20px, 200% 200%, 200% 200%;
    border: 2px solid rgba(255, 255, 255, 0.2);
    animation: gradientMove 8s ease infinite;
}

.card-back .pattern {
    font-size: 40px;
    opacity: 0.8;
}

@keyframes gradientMove {
    0%, 100% { background-position: 0% 0%, 0% 0%, 100% 100%; }
    50% { background-position: 20px 20px, 100% 100%, 0% 0%; }
}

.player-card {
    width: 140px;
    height: 200px;
    border-radius: 20px;
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition-bounce);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    border: 2px solid transparent;
}

.player-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: var(--transition-smooth);
}

.player-card:hover {
    transform: translateY(-10px) scale(1.05);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    border-color: var(--accent);
}

.player-card:hover img {
    transform: scale(1.1);
}

/* تأثير الغبار السحري عند النقر */
.magic-dust {
    position: fixed;
    pointer-events: none;
    z-index: 1000;
    transform: translate(-50%, -50%);
}

.magic-particle {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: floatUp 1.2s ease-out forwards;
    filter: blur(1px);
    box-shadow: 0 0 10px currentColor;
}

.magic-particle:nth-child(3n) {
    animation-duration: 1.4s;
}

.magic-particle:nth-child(3n+1) {
    animation-duration: 1s;
}

@keyframes floatUp {
    0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
    }
    100% {
        transform: translate(var(--tx), var(--ty)) scale(0);
        opacity: 0;
    }
}

/* شخصية المرشد */
.mascot {
    position: fixed;
    bottom: 90px;
    right: 25px;
    width: 90px;
    height: 90px;
    background: var(--gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.3),
        0 0 0 3px rgba(255, 255, 255, 0.1);
    z-index: 100;
    transition: var(--transition-bounce);
    animation: bounce 2s infinite;
}

.mascot:hover {
    transform: scale(1.15) rotate(10deg);
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 0 5px rgba(255, 255, 255, 0.2);
}

.mascot i {
    font-size: 42px;
    color: white;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    transition: var(--transition-smooth);
}

.mascot:hover i {
    transform: scale(1.2);
}

.mascot-dialog {
    position: absolute;
    bottom: calc(100% + 15px);
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    color: var(--dark);
    padding: 20px;
    border-radius: 20px;
    width: 280px;
    box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    display: none;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    z-index: 101;
    transform-origin: bottom right;
}

.mascot-dialog.show {
    display: block;
    animation: slideInUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.mascot-dialog::after {
    content: '';
    position: absolute;
    top: 100%;
    right: 20px;
    border-width: 10px;
    border-style: solid;
    border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
    filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
}

.mascot-dialog p {
    margin-bottom: 15px;
    font-size: 16px;
    line-height: 1.6;
    font-weight: 500;
}

.mascot-dialog .btn-small {
    background: var(--gradient);
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: var(--transition-smooth);
    display: block;
    margin-left: auto;
}

.mascot-dialog .btn-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* تأثيرات Confetti محسنة */
.confetti {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
}

.confetti-emoji {
    position: fixed;
    z-index: 9999;
    pointer-events: none;
    animation: confettiFall 2s cubic-bezier(0.215, 0.61, 0.355, 1) forwards;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

@keyframes confettiFall {
    0% {
        transform: 
            translateY(-100px) 
            rotate(0deg) 
            scale(0.5);
        opacity: 0;
    }
    10% {
        opacity: 1;
        transform: 
            translateY(0) 
            rotate(180deg) 
            scale(1.2);
    }
    100% {
        transform: 
            translateY(1000px) 
            rotate(720deg) 
            scale(0.5);
        opacity: 0;
    }
}

.floating-star {
    position: fixed;
    z-index: 9999;
    pointer-events: none;
    filter: drop-shadow(0 0 10px currentColor);
}

/* زر التمرير للأعلى */
.scroll-to-top {
    position: fixed;
    bottom: 90px;
    left: 25px;
    width: 60px;
    height: 60px;
    background: var(--gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transition: var(--transition-bounce);
    z-index: 100;
    opacity: 0;
    transform: translateY(30px) scale(0.8);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.scroll-to-top.show {
    opacity: 1;
    transform: translateY(0) scale(1);
}

.scroll-to-top:hover {
    transform: scale(1.15) translateY(-5px);
    box-shadow: 
        0 12px 35px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    background: linear-gradient(120deg, #fd79a8, #6c5ce7);
}

.scroll-to-top i {
    font-size: 24px;
    transition: var(--transition-smooth);
}

.scroll-to-top:hover i {
    transform: translateY(-3px);
}

/* أزرار محسنة */
.btn {
    background: var(--gradient);
    color: white;
    border: none;
    padding: 14px 32px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 700;
    box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transition: var(--transition-bounce);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    border: 2px solid transparent;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.7s ease;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 
        0 15px 30px rgba(0, 0, 0, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.3);
    background: linear-gradient(120deg, #fd79a8, #6c5ce7);
}

.btn:active {
    transform: translateY(-2px) scale(1.02);
}

.btn i {
    font-size: 20px;
    transition: var(--transition-smooth);
}

.btn:hover i {
    transform: scale(1.2);
}

/* تأثير الريبل */
.ripple {
    position: relative;
    overflow: hidden;
}

.ripple:after {
    content: "";
    display: block;
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
    background-image: radial-gradient(circle, rgba(255, 255, 255, 0.4) 10%, transparent 10.01%);
    background-repeat: no-repeat;
    background-position: 50%;
    transform: scale(10, 10);
    opacity: 0;
    transition: transform 0.5s, opacity 1s;
}

.ripple:active:after {
    transform: scale(0, 0);
    opacity: 0.3;
    transition: 0s;
}

/* شريط التقدم */
.progress-bar {
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    margin: 20px 0;
    overflow: hidden;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
    position: relative;
}

.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    animation: shimmerProgress 2s infinite;
}

.progress {
    height: 100%;
    background: var(--gradient);
    border-radius: 10px;
    width: 0%;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.progress::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmerProgress 1.5s infinite;
}

@keyframes shimmerProgress {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* إطار النجاح */
.success-glow {
    animation: successGlow 2s ease-in-out infinite;
    position: relative;
}

.success-glow::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: var(--gradient);
    border-radius: inherit;
    z-index: -1;
    animation: successGlow 2s ease-in-out infinite;
}

@keyframes successGlow {
    0%, 100% { 
        box-shadow: 0 0 25px rgba(0, 184, 148, 0.4);
    }
    50% { 
        box-shadow: 0 0 50px rgba(0, 184, 148, 0.8);
    }
}

/* شريط التنقل السفلي */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%; 
    height: 70px; 
    padding: 15px 20px;
    display: flex;
    justify-content: space-around;
    z-index: 9999;
    background: rgba(44, 62, 80, 0.95);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border-top: 1px solid var(--glass-border);
    box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2);
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: var(--light);
    text-decoration: none;
    font-size: 13px;
    padding: 12px 20px;
    border-radius: 20px;
    transition: var(--transition-bounce);
    background: rgba(255, 255, 255, 0.05);
    min-width: 80px;
}

.nav-item.active {
    color: var(--accent);
    background: rgba(253, 121, 168, 0.2);
    transform: translateY(-10px);
    box-shadow: 
        0 10px 25px rgba(253, 121, 168, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.nav-item i {
    font-size: 24px;
    margin-bottom: 6px;
    transition: var(--transition-smooth);
}

.nav-item.active i {
    transform: scale(1.3) translateY(-3px);
    animation: iconPulse 2s infinite;
}

.nav-item span {
    font-weight: 600;
    letter-spacing: 0.5px;
    transition: var(--transition-smooth);
}

.nav-item.active span {
    transform: translateY(2px);
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1.3) translateY(-3px); }
    50% { transform: scale(1.4) translateY(-5px); }
}

/* أنماط اللعبة */
.mode-tabs {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.mode-tab {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid transparent;
    color: var(--light);
    padding: 12px 24px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: var(--transition-bounce);
    display: flex;
    align-items: center;
    gap: 8px;
    letter-spacing: 0.5px;
}

.mode-tab i {
    font-size: 18px;
    transition: var(--transition-smooth);
}

.mode-tab.active {
    background: var(--gradient);
    color: white;
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transform: translateY(-3px);
}

.mode-tab:hover:not(.active) {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

/* المؤقت */
.timer-container {
    padding: 12px 24px;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    font-size: 18px;
    transition: var(--transition-smooth);
}

.timer-container.warning {
    animation: timerWarning 1s ease-in-out infinite alternate;
}

@keyframes timerWarning {
    from {
        background: rgba(214, 48, 49, 0.2);
        box-shadow: 0 0 20px rgba(214, 48, 49, 0.3);
    }
    to {
        background: rgba(214, 48, 49, 0.4);
        box-shadow: 0 0 30px rgba(214, 48, 49, 0.5);
    }
}

/* التلميحات */
.hint-container {
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}

.hint-btn {
    background: linear-gradient(135deg, #00b894, #00cec9);
}

.hint-text {
    margin-top: 15px;
    padding: 15px;
    border-radius: 15px;
    display: none;
    animation: fadeIn 0.5s ease;
    line-height: 1.6;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* رسائل التطبيق */
.message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    padding: 30px;
    border-radius: 25px;
    text-align: center;
    display: none;
    z-index: 1000;
    width: 90%;
    max-width: 400px;
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border: 2px solid var(--accent);
    opacity: 0;
    transition: var(--transition-bounce);
}

.message.show {
    display: block;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    animation: messagePulse 2s infinite alternate;
}

.message i {
    font-size: 60px;
    margin-bottom: 20px;
    color: var(--accent);
    filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
    animation: iconFloat 3s ease-in-out infinite;
}

.message h3 {
    font-size: 28px;
    margin-bottom: 15px;
    color: var(--warning);
    font-weight: 800;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.message p {
    margin-bottom: 25px;
    font-size: 18px;
    line-height: 1.6;
    color: var(--light);
}

@keyframes messagePulse {
    from { 
        box-shadow: 
            0 20px 50px rgba(253, 121, 168, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    to { 
        box-shadow: 
            0 20px 70px rgba(253, 121, 168, 0.5),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
}

@keyframes iconFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-10px) rotate(5deg); }
}

/* ألغاز ثقافية */
.cultural-puzzle-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s ease;
    backdrop-filter: blur(10px);
    overflow-y: auto;
    padding: 20px 0;
}

.cultural-puzzle-overlay.active {
    opacity: 1;
    visibility: visible;
}

.cultural-puzzle-container {
    width: 90%;
    max-width: 500px;
    padding: 30px;
    border-radius: 25px;
    text-align: center;
    color: white;
    position: relative;
    overflow: hidden;
    animation: puzzleAppear 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes puzzleAppear {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.puzzle-header h2 {
    margin: 0 0 15px 0;
    font-size: 28px;
    background: var(--gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    font-weight: 800;
}

.puzzle-category {
    background-color: rgba(255, 255, 255, 0.15);
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 15px;
    display: inline-block;
    margin-bottom: 20px;
    color: var(--secondary);
    font-weight: 700;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.puzzle-instruction {
    margin: 20px 0;
    font-style: italic;
    opacity: 0.9;
    color: var(--light);
    font-size: 16px;
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    border-radius: 15px;
}

.puzzle-question {
    font-size: 20px;
    margin: 25px 0;
    line-height: 1.8;
    color: var(--light);
    background: rgba(255, 255, 255, 0.05);
    padding: 20px;
    border-radius: 20px;
    border-left: 5px solid var(--accent);
    text-align: center;
    font-weight: 600;
}

.puzzle-options {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin: 25px 0;
}

.puzzle-option {
    padding: 18px;
    border-radius: 15px;
    color: var(--light);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition-smooth);
    font-weight: 600;
    backdrop-filter: blur(10px);
    border: 2px solid transparent;
    text-align: right;
}

.puzzle-option:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: translateY(-5px);
    border-color: var(--secondary);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.puzzle-option.correct {
    background-color: rgba(0, 184, 148, 0.3);
    border-color: var(--success);
    color: var(--light);
}

.puzzle-option.incorrect {
    background-color: rgba(214, 48, 49, 0.3);
    border-color: var(--danger);
    color: var(--light);
}

.puzzle-result {
    margin: 25px 0 0 0;
    padding: 20px;
    border-radius: 15px;
    font-weight: 800;
    font-size: 18px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: resultAppear 0.5s ease;
}

@keyframes resultAppear {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.puzzle-result.correct {
    background-color: rgba(0, 184, 148, 0.3);
    color: var(--success);
    border-color: rgba(0, 184, 148, 0.5);
}

.puzzle-result.incorrect {
    background-color: rgba(214, 48, 49, 0.3);
    color: var(--danger);
    border-color: rgba(214, 48, 49, 0.5);
}

/* إنجازات تظهر */
.achievement-badge {
    position: fixed;
    top: 30px;
    right: 30px;
    background: var(--gradient);
    color: white;
    padding: 15px 25px;
    border-radius: 50px;
    box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 1000;
    transform: translateX(150%);
    transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.achievement-badge.show {
    transform: translateX(0);
}

.achievement-badge i {
    font-size: 28px;
    animation: trophySpin 2s ease-in-out infinite;
}

@keyframes trophySpin {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(-15deg) scale(1.1); }
    75% { transform: rotate(15deg) scale(1.1); }
}

/* تأثير النجوم في الخلفية */
.star {
    position: absolute;
    background-color: white;
    border-radius: 50%;
    animation: twinkle 4s infinite;
    pointer-events: none;
    box-shadow: 0 0 20px white;
}

@keyframes twinkle {
    0%, 100% { 
        opacity: 0.2; 
        transform: scale(1);
    }
    50% { 
        opacity: 1; 
        transform: scale(1.2);
    }
}

/* تخصيص شريط التمرير */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    margin: 5px;
}

::-webkit-scrollbar-thumb {
    background: var(--gradient);
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.1);
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(120deg, #fd79a8, #6c5ce7);
}

/* تحسينات للشاشات الصغيرة */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    h1 {
        font-size: 26px;
    }
    
    .stages-map {
        min-height: 450px;
    }
    
    .stage-point {
        width: 60px;
        height: 60px;
    }
    
    .stage-point i {
        font-size: 22px;
    }
    
    .levels-grid {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 15px;
    }
    
    .card, .player-card {
        width: 120px;
        height: 170px;
    }
    
    .mascot {
        width: 70px;
        height: 70px;
        bottom: 80px;
        right: 15px;
    }
    
    .mascot i {
        font-size: 32px;
    }
    
    .mascot-dialog {
        width: 250px;
        padding: 15px;
    }
    
    .scroll-to-top {
        width: 50px;
        height: 50px;
        bottom: 80px;
        left: 15px;
    }
    
    .bottom-nav {
        padding: 10px 15px;
    }
    
    .nav-item {
        padding: 8px 15px;
        min-width: 70px;
    }
    
    .nav-item i {
        font-size: 20px;
    }
    
    .btn {
        padding: 12px 24px;
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    h1 {
        font-size: 22px;
    }
    
    .total-points {
        font-size: 18px;
        padding: 10px 20px;
    }
    
    .stages-map {
        min-height: 400px;
    }
    
    .stage-point {
        width: 50px;
        height: 50px;
    }
    
    .stage-point i {
        font-size: 18px;
    }
    
    .stage-point span {
        font-size: 12px;
    }
    
    .card, .player-card {
        width: 120px;
        height: 160px;
    }
    
    .app-cards, .player-cards {
        gap: 10px;
    }
    
    .levels-grid {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 12px;
    }
    
    .mode-tab {
        padding: 10px 20px;
        font-size: 14px;
    }
    
    .mascot {
        width: 60px;
        height: 60px;
        bottom: 70px;
    }
    
    .mascot i {
        font-size: 28px;
    }
    
    .mascot-dialog {
        width: 220px;
        right: -10px;
    }
    
    .scroll-to-top {
        width: 45px;
        height: 45px;
        bottom: 70px;
    }
    
    .cultural-puzzle-container {
        padding: 20px 15px;
    }
    
    .puzzle-question {
        font-size: 18px;
        padding: 15px;
    }
    
    .puzzle-option {
        padding: 15px;
        font-size: 15px;
    }
}

/* وضع التحميل للصور */
.card-image.loading {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    position: relative;
    overflow: hidden;
}

.card-image.loading::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: loadingShimmer 1.5s infinite;
}

@keyframes loadingShimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.card-image.error {
    background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    text-align: center;
}

/* تأثيرات اهتزاز */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
}

.shake {
    animation: shake 0.8s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
}

/* تأثيرات تدريجية للظهور */
.fade-in-up {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
    transform: translateY(30px);
}

@keyframes fadeInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* تلميحات الواجهة */
.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    width: 220px;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    text-align: center;
    border-radius: 12px;
    padding: 12px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    font-size: 14px;
    line-height: 1.5;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.tooltip .tooltiptext::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
    transform: translateX(-50%) translateY(-5px);
}

/* أحزمة التميز */
.ribbon {
    position: absolute;
    top: 10px;
    right: -10px;
    background: var(--gradient);
    color: white;
    padding: 5px 15px;
    font-size: 12px;
    font-weight: 700;
    border-radius: 5px 0 0 5px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 3;
    animation: ribbonGlow 2s infinite alternate;
}

.ribbon::before {
    content: '';
    position: absolute;
    top: 100%;
    right: 0;
    border-width: 5px;
    border-style: solid;
    border-color: var(--primary) transparent transparent var(--primary);
}

@keyframes ribbonGlow {
    from {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    to {
        box-shadow: 0 4px 20px rgba(108, 92, 231, 0.5);
    }
}

/* تأثيرات النص */
.text-gradient {
    background: var(--gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    display: inline-block;
}

/* تأثيرات الظل للعناصر */
.shadow-elevated {
    box-shadow: 
        0 4px 6px rgba(0, 0, 0, 0.1),
        0 10px 20px rgba(0, 0, 0, 0.15),
        0 20px 40px rgba(0, 0, 0, 0.2);
}

/* تأثيرات الاهتزاز الناعمة */
.vibrate-soft {
    animation: vibrateSoft 0.3s linear infinite both;
}

@keyframes vibrateSoft {
    0% { transform: translate(0); }
    20% { transform: translate(-2px, 2px); }
    40% { transform: translate(-2px, -2px); }
    60% { transform: translate(2px, 2px); }
    80% { transform: translate(2px, -2px); }
    100% { transform: translate(0); }
}

/* تأثيرات الوهج */
.glow-effect {
    position: relative;
}

.glow-effect::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.glow-effect:hover::after {
    opacity: 1;
}

/* تخصيص الإدخال */
input, textarea, select {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 12px 16px;
    color: var(--light);
    font-size: 16px;
    transition: var(--transition-smooth);
    width: 100%;
}

input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 3px rgba(253, 121, 168, 0.1);
}

input::placeholder, textarea::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

/* تنسيقات النصوص */
h1, h2, h3, h4, h5, h6 {
    line-height: 1.3;
    margin-bottom: 1rem;
}

p {
    margin-bottom: 1rem;
    line-height: 1.7;
}

.text-center {
    text-align: center;
}

.text-right {
    text-align: right;
}

.text-left {
    text-align: left;
}

/* ألوان النصوص */
.text-primary { color: var(--primary); }
.text-secondary { color: var(--secondary); }
.text-accent { color: var(--accent); }
.text-success { color: var(--success); }
.text-warning { color: var(--warning); }
.text-danger { color: var(--danger); }
.text-light { color: var(--light); }
.text-dark { color: var(--dark); }

/* خلفيات الألوان */
.bg-primary { background: var(--primary); }
.bg-secondary { background: var(--secondary); }
.bg-accent { background: var(--accent); }
.bg-success { background: var(--success); }
.bg-warning { background: var(--warning); }
.bg-danger { background: var(--danger); }
.bg-light { background: var(--light); }
.bg-dark { background: var(--dark); }
.bg-gradient { background: var(--gradient); }

/* هوامش وحشوات */
.m-0 { margin: 0; }
.m-1 { margin: 0.5rem; }
.m-2 { margin: 1rem; }
.m-3 { margin: 1.5rem; }
.m-4 { margin: 2rem; }

.p-0 { padding: 0; }
.p-1 { padding: 0.5rem; }
.p-2 { padding: 1rem; }
.p-3 { padding: 1.5rem; }
.p-4 { padding: 2rem; }

/* فلوكس بوكس */
.flex { display: flex; }
.flex-column { flex-direction: column; }
.flex-row { flex-direction: row; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }
.align-center { align-items: center; }
.align-start { align-items: flex-start; }
.align-end { align-items: flex-end; }

/* جريد */
.grid { display: grid; }
.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }
.gap-1 { gap: 0.5rem; }
.gap-2 { gap: 1rem; }
.gap-3 { gap: 1.5rem; }
.gap-4 { gap: 2rem; }

/* مستويات الظهور */
.z-0 { z-index: 0; }
.z-1 { z-index: 1; }
.z-2 { z-index: 2; }
.z-3 { z-index: 3; }
.z-10 { z-index: 10; }
.z-100 { z-index: 100; }
.z-1000 { z-index: 1000; }

/* تأثيرات الحركة */
.animate-fade-in {
    animation: fadeIn 0.5s ease forwards;
}

.animate-slide-up {
    animation: slideUp 0.5s ease forwards;
}

.animate-slide-down {
    animation: slideDown 0.5s ease forwards;
}

.animate-slide-left {
    animation: slideLeft 0.5s ease forwards;
}

.animate-slide-right {
    animation: slideRight 0.5s ease forwards;
}

.animate-scale {
    animation: scale 0.5s ease forwards;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes slideDown {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes slideLeft {
    from { transform: translateX(50px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideRight {
    from { transform: translateX(-50px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes scale {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* تأثيرات دورية */
.pulse {
    animation: pulse 2s infinite;
}

.spin {
    animation: spin 1s linear infinite;
}

.bounce {
    animation: bounce 2s infinite;
}

.float {
    animation: float 3s ease-in-out infinite;
}

/* وضع الإخفاء */
.hidden {
    display: none !important;
}

.visible {
    display: block !important;
}

.opacity-0 { opacity: 0; }
.opacity-25 { opacity: 0.25; }
.opacity-50 { opacity: 0.5; }
.opacity-75 { opacity: 0.75; }
.opacity-100 { opacity: 1; }

.pointer-events-none { pointer-events: none; }
.pointer-events-auto { pointer-events: auto; }

.user-select-none { user-select: none; }
.user-select-text { user-select: text; }

/* أحجام الخطوط */
.text-xs { font-size: 0.75rem; }
.text-sm { font-size: 0.875rem; }
.text-base { font-size: 1rem; }
.text-lg { font-size: 1.125rem; }
.text-xl { font-size: 1.25rem; }
.text-2xl { font-size: 1.5rem; }
.text-3xl { font-size: 1.875rem; }
.text-4xl { font-size: 2.25rem; }
.text-5xl { font-size: 3rem; }

/* أوزان الخطوط */
.font-light { font-weight: 300; }
.font-normal { font-weight: 400; }
.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-bold { font-weight: 700; }
.font-extrabold { font-weight: 800; }

/* إعادة تحميل الرموز */
.icon-spin {
    animation: iconSpin 2s linear infinite;
}

@keyframes iconSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* تحسينات للطباعة */
@media print {
    .no-print {
        display: none !important;
    }
    
    body {
        color: black !important;
        background: white !important;
    }
    
    .glass-effect, .glass-effect-light {
        background: white !important;
        box-shadow: none !important;
        border: 1px solid #ccc !important;
    }
}

/* تحسينات الوصول */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* تحسينات وضع التباين العالي */
@media (prefers-contrast: high) {
    :root {
        --primary: #4a3bc9;
        --secondary: #7b6cfc;
        --accent: #e65a8c;
        --success: #009e7a;
        --warning: #e8b859;
        --danger: #b32727;
        --dark: #1a1a1a;
        --light: #ffffff;
    }
}

/* تحسينات وضع التوفير في الطاقة */
@media (prefers-reduced-transparency: reduce) {
    .glass-effect, .glass-effect-light {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        background: rgba(44, 62, 80, 0.95);
    }
}

/* حالة التركيز للوصول */
:focus-visible {
    outline: 3px solid var(--accent);
    outline-offset: 3px;
}

/* حالة النشاط */
:active {
    transform: none;
}

/* تحسينات المحتوى الديناميكي */
.content {
    min-height: calc(100vh - 120px);
    padding-bottom: 80px;
}

/* تحسينات العلامات */
mark {
    background: var(--gradient);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
}

/* تحسينات الشعارات */
.logo {
    display: inline-block;
    font-size: 2rem;
    font-weight: 800;
    background: var(--gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* تأثيرات النهاية */
.final-score {
    font-size: 4rem;
    font-weight: 800;
    background: var(--gradient);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    animation: finalScore 1s ease-out forwards;
}

@keyframes finalScore {
    0% {
        transform: scale(0.5);
        opacity: 0;
    }
    70% {
        transform: scale(1.2);
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* تأثيرات الانطلاق */
.launch-effect {
    animation: launch 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

@keyframes launch {
    0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
    }
    100% {
        transform: scale(1) rotate(360deg);
        opacity: 1;
    }
}

        /* أنماط داخلية إضافية */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div class="loading-overlay" id="loading-screen" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div class="loading-text" id="loading-text">جاري تحضير المغامرة...</div>
        <div class="visually-hidden">جاري تحميل اللعبة، الرجاء الانتظار</div>
    </div>

    <!-- شخصية المرشد -->
    <div class="mascot" id="mascot" role="button" aria-label="فتح نافذة مساعد اللعبة" tabindex="0">
        <i class="fas fa-robot" aria-hidden="true"></i>
        <div class="mascot-dialog" id="mascot-dialog" role="dialog" aria-labelledby="mascot-message" aria-hidden="true">
            <p id="mascot-message">مرحباً! أنا مساعدك في هذه المغامرة. انقر عليّ للحصول على المساعدة!</p>
            <button class="btn btn-small" id="mascot-close" aria-label="إغلاق نافذة المساعد">حسناً</button>
        </div>
    </div>

    <!-- زر التمرير للأعلى -->
    <button class="scroll-to-top" id="scroll-to-top" aria-label="التمرير إلى الأعلى">
        <i class="fas fa-chevron-up" aria-hidden="true"></i>
    </button>

    <!-- حاوية التطبيق الرئيسية -->
    <div class="app-container" role="main">
        <div class="content">
            <div class="container">
                <!-- شاشة المراحل مع الخريطة -->
                <section id="stages-screen" class="screen active" role="region" aria-labelledby="stages-title">
                    <header class="glass-effect" role="banner">
                        <h1 id="stages-title">
                            <i class="fas fa-dragon" aria-hidden="true"></i>
                            أبطال البطاقات
                            <i class="fas fa-dragon" aria-hidden="true"></i>
                        </h1>
                        <div class="total-points glass-effect-light">
                            <i class="fas fa-coins" aria-hidden="true"></i>
                            <span id="total-points">0</span> نقطة
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="total-progress" style="width: 0%" 
                                 role="progressbar" 
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span class="sr-only">0% من التقدم الكلي</span>
                            </div>
                        </div>
                    </header>
                    
                    <div class="stages-map" id="stages-map" role="region" aria-label="خريطة المراحل">
                        <h2 class="sr-only">خريطة المراحل</h2>
                        <!-- سيتم إضافة نقاط المراحل ديناميكياً -->
                    </div>
                    
                    <div class="instructions glass-effect" style="margin-top: 20px; padding: 20px;">
                        <h3 style="margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i> تعليمات اللعبة
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="instruction-item glass-effect-light" style="padding: 15px; border-radius: 15px;">
                                <i class="fas fa-map" style="color: var(--primary); margin-bottom: 10px;"></i>
                                <p>اختر المرحلة من الخريطة لبدء التحدي</p>
                            </div>
                            <div class="instruction-item glass-effect-light" style="padding: 15px; border-radius: 15px;">
                                <i class="fas fa-puzzle-piece" style="color: var(--secondary); margin-bottom: 10px;"></i>
                                <p>حل الألغاز الثقافية لربح نقاط إضافية</p>
                            </div>
                            <div class="instruction-item glass-effect-light" style="padding: 15px; border-radius: 15px;">
                                <i class="fas fa-lightbulb" style="color: var(--warning); margin-bottom: 10px;"></i>
                                <p>استخدم التلميحات بحكمة لمساعدتك</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- شاشة المستويات -->
                <section id="levels-screen" class="screen" role="region" aria-labelledby="levels-title">
                    <header class="glass-effect" role="banner">
                        <h1 id="levels-title">
                            <span id="stage-title">المرحلة 1</span>
                            <i class="fas fa-arrow-left" style="margin: 0 10px;" aria-hidden="true"></i>
                            <button class="btn btn-small" id="back-to-stages-btn" aria-label="العودة إلى الخريطة">
                                <i class="fas fa-map" aria-hidden="true"></i>
                                الخريطة
                            </button>
                        </h1>
                        <div class="total-points glass-effect-light">
                            <i class="fas fa-coins" aria-hidden="true"></i>
                            <span id="stage-points">0</span> نقطة
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="stage-progress" style="width: 0%"
                                 role="progressbar" 
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span class="sr-only">0% من تقدم المرحلة</span>
                            </div>
                        </div>
                    </header>
                    
                    <div class="game-modes glass-effect" role="tablist" aria-label="أنماط اللعب">
                        <h3 style="text-align: center; margin-bottom: 15px; color: var(--secondary);">
                            <i class="fas fa-gamepad"></i> اختر نمط اللعب
                        </h3>
                        <div class="mode-tabs">
                            <button class="mode-tab active" 
                                    data-mode="normal" 
                                    role="tab" 
                                    aria-selected="true"
                                    aria-controls="normal-levels">
                                <i class="fas fa-flag" aria-hidden="true"></i>
                                المستويات العادية
                            </button>
                            <button class="mode-tab" 
                                    data-mode="daily" 
                                    role="tab" 
                                    aria-selected="false"
                                    aria-controls="daily-challenges">
                                <i class="fas fa-calendar-day" aria-hidden="true"></i>
                                التحدي اليومي
                            </button>
                            <button class="mode-tab" 
                                    data-mode="timed" 
                                    role="tab" 
                                    aria-selected="false"
                                    aria-controls="timed-challenges">
                                <i class="fas fa-stopwatch" aria-hidden="true"></i>
                                الوقت المحدد
                            </button>
                        </div>
                    </div>
                    
                    <div class="levels-container" role="tabpanel" id="normal-levels">
                        <h2 class="sr-only">المستويات العادية</h2>
                        <div class="levels-grid" id="levels-container">
                            <!-- سيتم ملء المستويات ديناميكيًا -->
                        </div>
                    </div>
                    
                    <div class="levels-container" role="tabpanel" id="daily-challenges" hidden>
                        <h2 class="sr-only">التحدي اليومي</h2>
                        <div class="daily-levels-grid" id="daily-levels-container">
                            <!-- سيتم ملء التحديات اليومية ديناميكيًا -->
                        </div>
                    </div>
                    
                    <div class="levels-container" role="tabpanel" id="timed-challenges" hidden>
                        <h2 class="sr-only">التحدي المحدد بالوقت</h2>
                        <div class="timed-levels-grid" id="timed-levels-container">
                            <!-- سيتم ملء تحديات الوقت ديناميكيًا -->
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn ripple" id="random-level-btn" aria-label="مستوى عشوائي">
                            <i class="fas fa-random" aria-hidden="true"></i>
                            تحدٍ عشوائي
                        </button>
                    </div>
                </section>
                
                <!-- شاشة اللعبة -->
                <section id="game-screen" class="screen" role="region" aria-labelledby="game-title">
                    <header class="glass-effect" role="banner">
                        <h1 id="game-title">
                            <span id="current-stage">1</span> 
                            <i class="fas fa-arrow-left" aria-hidden="true"></i>
                            المرحلة 
                            <span style="margin: 0 10px;">-</span>
                            المستوى 
                            <i class="fas fa-arrow-right" aria-hidden="true"></i>
                            <span id="current-level">1</span>
                        </h1>
                        <div class="game-info">
                            <div class="total-points glass-effect-light">
                                <i class="fas fa-star" aria-hidden="true"></i>
                                النقاط: <span id="level-points">0</span>/3
                            </div>
                            <div class="timer-container glass-effect-light" id="timer-container" style="display: none;"
                                 role="timer" 
                                 aria-live="polite">
                                <i class="fas fa-clock" aria-hidden="true"></i>
                                <span id="timer">60</span> ثانية
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="level-progress" style="width: 0%"
                                 role="progressbar" 
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span class="sr-only">0% من تقدم المستوى</span>
                            </div>
                        </div>
                    </header>
                    
                    <div class="game-instructions glass-effect" style="margin-bottom: 20px; padding: 15px;">
                        <h3 style="margin-bottom: 10px; color: var(--secondary);">
                            <i class="fas fa-graduation-cap"></i> كيف تلعب؟
                        </h3>
                        <ol style="padding-right: 20px; line-height: 1.8;">
                            <li>انقر على بطاقة اللغز لقلبها</li>
                            <li>انقر على بطاقة الحل المناسبة</li>
                            <li>حاول إيجاد 3 تطابقات صحيحة</li>
                            <li>استخدم التلميحات إذا واجهتك صعوبة</li>
                        </ol>
                    </div>
                    
                    <div class="hint-container glass-effect" id="hint-container" role="region" aria-label="قسم التلميحات">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: var(--secondary);">
                                <i class="fas fa-lightbulb"></i> التلميحات
                            </h3>
                            <span class="points-badge glass-effect-light" style="padding: 5px 15px; border-radius: 20px;">
                                <i class="fas fa-coins" style="color: var(--warning);"></i>
                                <span id="current-points">0</span>
                            </span>
                        </div>
                        <button class="btn hint-btn" id="hint-btn" aria-label="استخدام تلميح يكلف 10 نقاط">
                            <i class="fas fa-lightbulb" aria-hidden="true"></i>
                            تلميح (<span id="hint-cost">10</span> نقطة)
                        </button>
                        <div class="hint-text glass-effect-light" id="hint-text" role="alert" aria-live="polite" hidden>
                            <!-- سيتم عرض نص التلميح هنا -->
                        </div>
                    </div>
                    
                    <div class="cards-container">
                        <section class="cards-section glass-effect" role="region" aria-labelledby="app-cards-title">
                            <h2 id="app-cards-title">
                                <i class="fas fa-robot" aria-hidden="true"></i>
                                بطاقات التحدي
                            </h2>
                            <div class="app-cards" id="app-cards" role="grid" aria-label="بطاقات الألغاز">
                                <!-- سيتم ملء بطاقات التطبيق ديناميكيًا -->
                            </div>
                        </section>
                        
                        <section class="cards-section glass-effect" role="region" aria-labelledby="player-cards-title">
                            <h2 id="player-cards-title">
                                <i class="fas fa-user" aria-hidden="true"></i>
                                بطاقات الحل
                            </h2>
                            <div class="player-cards" id="player-cards" role="grid" aria-label="بطاقات الحلول">
                                <!-- سيتم ملء بطاقات اللاعب ديناميكيًا -->
                            </div>
                        </section>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <div class="action-buttons" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn ripple" id="restart-level-btn" aria-label="إعادة تشغيل المستوى">
                                <i class="fas fa-redo" aria-hidden="true"></i>
                                إعادة المحاولة
                            </button>
                            <button class="btn ripple" id="back-to-levels-btn" aria-label="العودة إلى قائمة المستويات">
                                <i class="fas fa-list" aria-hidden="true"></i>
                                قائمة المستويات
                            </button>
                            <button class="btn ripple" id="next-level-btn" aria-label="المستوى التالي" style="display: none;">
                                <i class="fas fa-arrow-right" aria-hidden="true"></i>
                                المستوى التالي
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- شاشة الملف الشخصي (مضمنة من ملف خارجي) -->
                <div id="profile-screen-container"></div>
                
                <!-- شاشة الإعدادات (مضمنة من ملف خارجي) -->
                <div id="settings-screen-container"></div>
                
                <!-- رسائل التطبيق -->
                <div class="message glass-effect" id="message" role="dialog" aria-labelledby="message-title" aria-hidden="true">
                    <div class="message-icon">
                        <i class="fas fa-trophy" aria-hidden="true"></i>
                    </div>
                    <h3 id="message-title" class="message-title">تهانينا!</h3>
                    <p id="message-text" class="message-text">لقد أكملت المستوى بنجاح</p>
                    <div class="message-actions">
                        <button class="btn ripple" id="message-btn" aria-label="موافق">
                            <i class="fas fa-check" aria-hidden="true"></i>
                            موافق
                        </button>
                    </div>
                </div>
                
                <!-- نافذة اللغز الثقافي -->
                <div class="cultural-puzzle-overlay" id="cultural-puzzle-overlay" role="dialog" aria-labelledby="puzzle-title" aria-hidden="true">
                    <!-- سيتم إضافة محتوى اللغز الثقافي ديناميكيًا -->
                </div>
                
                <!-- نافذة الإنجازات -->
                <div class="achievement-popup" id="achievement-popup" role="dialog" aria-labelledby="achievement-title" aria-hidden="true">
                    <!-- سيتم إضافة الإنجازات ديناميكيًا -->
                </div>
                
                <!-- نافذة النتيجة النهائية -->
                <div class="final-score-popup" id="final-score-popup" role="dialog" aria-labelledby="final-score-title" aria-hidden="true">
                    <!-- سيتم إضافة النتائج النهائية ديناميكيًا -->
                </div>
            </div>
        </div>
        
        <!-- شريط التنقل السفلي -->
        <nav class="bottom-nav" role="navigation" aria-label="التنقل الرئيسي">
            <a href="#" class="nav-item active" data-target="stages-screen" role="tab" aria-selected="true" aria-controls="stages-screen">
                <i class="fas fa-home" aria-hidden="true"></i>
                <span>الرئيسية</span>
            </a>
            <a href="#" class="nav-item" data-target="profile-screen" role="tab" aria-selected="false" aria-controls="profile-screen">
                <i class="fas fa-user" aria-hidden="true"></i>
                <span>الملف الشخصي</span>
            </a>
            <a href="#" class="nav-item" data-target="settings-screen" role="tab" aria-selected="false" aria-controls="settings-screen">
                <i class="fas fa-cog" aria-hidden="true"></i>
                <span>الإعدادات</span>
            </a>
            <button class="nav-item" id="quick-play-btn" aria-label="لعب سريع">
                <i class="fas fa-play" aria-hidden="true"></i>
                <span>لعب سريع</span>
            </button>
        </nav>
    </div>

    <!-- مكتبات JavaScript -->
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <!-- Toastify -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- GSAP (GreenSock Animation Platform) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    
    <!-- ملفات التطبيق -->
    <script src="sw.js"></script>
    
    <!-- ملفات JavaScript المنفصلة -->
    <script src="profile.js"></script>
    <script src="settings.js"></script>
    
    <script>
// تعريف المتغيرات العامة
let db;
let currentStage = 1;
let currentLevel = 1;
let levelPoints = 0;
let totalPoints = 0;
let selectedCard = null;
let userName = "المستخدم";
let userEmail = "";
let playTime = 0;
let playTimer;
let gameMode = "normal";
let gameTimer;
let timeLeft = 60;
let hintCost = 10;
let culturalPuzzles = [];
let mascotSystem;

// نظام الصوت
const audioSystem = {
    sounds: {},
    isEnabled: true,
    volume: 0.7,
    
    init: function() {
        // تهيئة جميع الأصوات
        this.sounds = {
            click: new Audio('sounds/click.mp3'),
            flip: new Audio('sounds/flip.mp3'),
            success: new Audio('sounds/success.mp3'),
            error: new Audio('sounds/error.mp3'),
            win: new Audio('sounds/win.mp3'),
            notification: new Audio('sounds/notification.mp3'),
            levelComplete: new Audio('sounds/level-complete.mp3'),
            star: new Audio('sounds/star.mp3'),
            background: new Audio('sounds/background-music.mp3'),
            culturalPuzzle: new Audio('sounds/cultural-puzzle.mp3'),
            hint: new Audio('sounds/hint.mp3'),
            unlock: new Audio('sounds/unlock.mp3'),
            coin: new Audio('sounds/coin.mp3'),
            achievement: new Audio('sounds/achievement.mp3'),
            timer: new Audio('sounds/timer.mp3'),
            applause: new Audio('sounds/applause.mp3')
        };
        
        // إعدادات الصوت
        Object.values(this.sounds).forEach(sound => {
            sound.volume = this.volume;
            sound.preload = 'auto';
        });
        
        // إعداد موسيقى الخلفية
        this.sounds.background.loop = true;
        this.sounds.background.volume = 0.3;
        
        // تحميل إعدادات الصوت من قاعدة البيانات
        this.loadSettings();
    },
    
    play: function(soundName, force = false) {
        if (!this.isEnabled && !force) return;
        
        const sound = this.sounds[soundName];
        if (sound) {
            // إعادة تعيين الصوت إذا كان يشتغل
            sound.currentTime = 0;
            
            // محاولة تشغيل الصوت
            sound.play().catch(error => {
                console.log(`Cannot play sound ${soundName}:`, error);
                // تشغيل صوت بديل إذا فشل تحميل الصوت الأصلي
                if (soundName === 'click') {
                    this.playFallbackClick();
                }
            });
        }
    },
    
    playFallbackClick: function() {
        // صوت نقرة بديل باستخدام Web Audio API
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(this.volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        } catch (e) {
            console.log("Cannot play fallback sound:", e);
        }
    },
    
    playBackgroundMusic: function() {
        if (this.isEnabled) {
            this.sounds.background.play().catch(error => {
                console.log("Cannot play background music:", error);
            });
        }
    },
    
    stopBackgroundMusic: function() {
        this.sounds.background.pause();
        this.sounds.background.currentTime = 0;
    },
    
    pauseBackgroundMusic: function() {
        this.sounds.background.pause();
    },
    
    resumeBackgroundMusic: function() {
        if (this.isEnabled && this.sounds.background.paused) {
            this.sounds.background.play().catch(error => {
                console.log("Cannot resume background music:", error);
            });
        }
    },
    
    toggleSound: function() {
        this.isEnabled = !this.isEnabled;
        
        if (this.isEnabled) {
            this.resumeBackgroundMusic();
        } else {
            this.pauseBackgroundMusic();
        }
        
        // حفظ الإعداد في قاعدة البيانات
        this.saveSettings();
        
        return this.isEnabled;
    },
    
    setVolume: function(volume) {
        this.volume = Math.max(0, Math.min(1, volume));
        Object.values(this.sounds).forEach(sound => {
            sound.volume = this.volume;
        });
        this.sounds.background.volume = this.volume * 0.3;
        
        // حفظ الإعداد في قاعدة البيانات
        this.saveSettings();
    },
    
    loadSettings: function() {
        if (!db) return;
        
        const transaction = db.transaction(['settings'], 'readonly');
        const settingsStore = transaction.objectStore('settings');
        
        const soundRequest = settingsStore.get('sound');
        soundRequest.onsuccess = (event) => {
            if (soundRequest.result) {
                this.isEnabled = soundRequest.result.value;
                window.soundEnabled = this.isEnabled;
            }
        };
        
        const volumeRequest = settingsStore.get('volume');
        volumeRequest.onsuccess = (event) => {
            if (volumeRequest.result) {
                this.setVolume(volumeRequest.result.value);
            }
        };
    },
    
    saveSettings: function() {
        if (!db) return;
        
        const transaction = db.transaction(['settings'], 'readwrite');
        const settingsStore = transaction.objectStore('settings');
        
        settingsStore.put({ id: 'sound', value: this.isEnabled });
        settingsStore.put({ id: 'volume', value: this.volume });
        
        window.soundEnabled = this.isEnabled;
    },
    
    // تشغيل مجموعة من الأصوات بالتتابع
    playSequence: function(soundNames, delay = 300) {
        soundNames.forEach((soundName, index) => {
            setTimeout(() => {
                this.play(soundName);
            }, index * delay);
        });
    }
};

// بيانات المراحل مع مواقع في الخريطة
const stagesData = [
    {
        id: 1,
        title: "غابة البداية",
        background: 'backgrounds/stage-1.jpg',
        requiredPoints: 0,
        levels: 23,
        position: { x: 10, y: 50 },
        description: "ابدأ رحلتك في هذه الغابة الغامضة"
    },
    {
        id: 2,
        title: "جبال التحدي",
        background: 'backgrounds/stage-2.jpg',
        requiredPoints: 69,
        levels: 25,
        position: { x: 30, y: 20 },
        description: "تسلق جبال التحدي الصعبة"
    },
    {
        id: 3,
        title: "وادي الألغاز",
        background: 'backgrounds/stage-3.jpg',
        requiredPoints: 144,
        levels: 30,
        position: { x: 50, y: 70 },
        description: "حل ألغاز الوادي العجيبة"
    },
    {
        id: 4,
        title: "قلعة الحكمة",
        background: 'backgrounds/stage-4.jpg',
        requiredPoints: 234,
        levels: 42,
        position: { x: 70, y: 30 },
        description: "ادخل قلعة الحكمة القديمة"
    },
    {
        id: 5,
        title: "قمة البطولة",
        background: 'backgrounds/stage-5.jpg',
        requiredPoints: 360,
        levels: 50,
        position: { x: 90, y: 50 },
        description: "وصل إلى قمة البطولة النهائية"
    }
];

const levelsData = [];

// إنشاء بيانات المستويات ديناميكيًا
let levelCounter = 1;
for (let stage = 1; stage <= stagesData.length; stage++) {
    const stageInfo = stagesData[stage-1];
    
    for (let level = 1; level <= stageInfo.levels; level++) {
        const cards = [];
        
        for (let j = 1; j <= 3; j++) {
            cards.push({ id: `${levelCounter}-${j}`, type: 'puzzle', path: `img/stage-${stage}/puzzle-${level}-${j}.jpg` });
            cards.push({ id: `${levelCounter}-${j}`, type: 'solution', path: `img/stage-${stage}/solution-${level}-${j}.jpg` });
        }
        
        levelsData.push({
            id: levelCounter,
            stage: stage,
            level: level,
            cards: cards,
            background: `backgrounds/level-${levelCounter}.jpg`,
            requiredPoints: (levelCounter > 1) ? (levelCounter-1) * 3 : 0
        });
        
        levelCounter++;
    }
}

// بيانات التحدي اليومي
const dailyChallenges = [
    {
        id: 1,
        title: "تحدي اليوم",
        background: 'backgrounds/daily-challenge.jpg',
        cards: [
            { id: 'daily-1-1', type: 'puzzle', path: 'img/daily/puzzle-1-1.jpg' },
            { id: 'daily-1-1', type: 'solution', path: 'img/daily/solution-1-1.jpg' },
            { id: 'daily-1-2', type: 'puzzle', path: 'img/daily/puzzle-1-2.jpg' },
            { id: 'daily-1-2', type: 'solution', path: 'img/daily/solution-1-2.jpg' },
            { id: 'daily-1-3', type: 'puzzle', path: 'img/daily/puzzle-1-3.jpg' },
            { id: 'daily-1-3', type: 'solution', path: 'img/daily/solution-1-3.jpg' }
        ]
    }
];

// بيانات تحدي الوقت
const timedChallenges = [
    {
        id: 1,
        title: "تحدي السرعة",
        background: 'backgrounds/timed-challenge.jpg',
        timeLimit: 60,
        cards: [
            { id: 'timed-1-1', type: 'puzzle', path: 'img/timed/puzzle-1-1.jpg' },
            { id: 'timed-1-1', type: 'solution', path: 'img/timed/solution-1-1.jpg' },
            { id: 'timed-1-2', type: 'puzzle', path: 'img/timed/puzzle-1-2.jpg' },
            { id: 'timed-1-2', type: 'solution', path: 'img/timed/solution-1-2.jpg' },
            { id: 'timed-1-3', type: 'puzzle', path: 'img/timed/puzzle-1-3.jpg' },
            { id: 'timed-1-3', type: 'solution', path: 'img/timed/solution-1-3.jpg' }
        ]
    }
];

// نظام شخصية المرشد
class MascotSystem {
    constructor() {
        this.messages = [
            "مرحباً! أنا روبو، مرشدك في رحلة البطولة!",
            "حل الألغاز الثقافية يكسبك نقاطاً إضافية!",
            "استخدم التلميحات بحكمة، فهي تكلف نقاطاً!",
            "حاول إكمال المستويات بسرعة لتحصل على إنجاز العداء السريع!",
            "أكمل 5 مستويات لتحصل على إنجاز البطل المبتدئ!",
            "التحدي اليومي يتجدد كل 24 ساعة، لا تفوته!",
            "شاهد النقاط تزداد وأنت تتقدم في الرحلة!",
            "كل مرحلة هي مغامرة جديدة مليئة بالتحديات!"
        ];
        
        this.currentMessageIndex = 0;
        this.isVisible = true;
    }
    
    showMessage(message = null) {
        if (!message) {
            message = this.messages[this.currentMessageIndex];
            this.currentMessageIndex = (this.currentMessageIndex + 1) % this.messages.length;
        }
        
        const dialog = document.getElementById('mascot-dialog');
        const messageElement = document.getElementById('mascot-message');
        
        messageElement.textContent = message;
        dialog.classList.add('show');
        
        // تشغيل صوت الإشعار
        audioSystem.play('notification');
        
        // إخفاء الرسالة تلقائياً بعد 5 ثوان
        setTimeout(() => {
            this.hideMessage();
        }, 5000);
    }
    
    hideMessage() {
        const dialog = document.getElementById('mascot-dialog');
        dialog.classList.remove('show');
    }
    
    toggleVisibility() {
        this.isVisible = !this.isVisible;
        const mascot = document.getElementById('mascot');
        mascot.style.display = this.isVisible ? 'flex' : 'none';
        audioSystem.play('click');
    }
}

// === تأثيرات الجزيئات والرسومات ===

// تأثير الجزيئات عند النقر على البطاقات
function createMagicDust(x, y) {
    const dustContainer = document.createElement('div');
    dustContainer.className = 'magic-dust';
    dustContainer.style.left = x + 'px';
    dustContainer.style.top = y + 'px';
    
    for (let i = 0; i < 15; i++) {
        const particle = document.createElement('div');
        particle.className = 'magic-particle';
        
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 100 + 50;
        const size = Math.random() * 8 + 2;
        
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.background = getRandomGradient();
        
        dustContainer.appendChild(particle);
        
        // حركة الجزيئات
        gsap.to(particle, {
            x: Math.cos(angle) * speed,
            y: Math.sin(angle) * speed,
            opacity: 0,
            scale: 0,
            duration: 1,
            ease: "power2.out",
            onComplete: () => {
                if (dustContainer.parentNode) {
                    dustContainer.removeChild(particle);
                    if (dustContainer.children.length === 0) {
                        dustContainer.remove();
                    }
                }
            }
        });
    }
    
    document.body.appendChild(dustContainer);
}

function getRandomGradient() {
    const gradients = [
        'linear-gradient(135deg, #6c5ce7, #fd79a8)',
        'linear-gradient(135deg, #00b894, #00cec9)',
        'linear-gradient(135deg, #fdcb6e, #e17055)',
        'linear-gradient(135deg, #a29bfe, #74b9ff)'
    ];
    return gradients[Math.floor(Math.random() * gradients.length)];
}

// تأثير Confetti محسن باستخدام Canvas Confetti
function createEnhancedConfetti() {
    // تأثير من المكتبة
    if (typeof confetti === 'function') {
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#6c5ce7', '#fd79a8', '#00b894', '#fdcb6e', '#a29bfe']
        });
    }
    
    // تشغيل صوت التصفيق
    audioSystem.play('applause');
    
    // تأثير إضافي مع emojis
    setTimeout(() => {
        for (let i = 0; i < 20; i++) {
            createEmojiConfetti();
        }
    }, 300);
}

function createEmojiConfetti() {
    const emojis = ['🎉', '🎊', '🏆', '⭐', '✨', '👑', '🎯', '💎'];
    const emoji = document.createElement('div');
    emoji.className = 'confetti-emoji';
    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    emoji.style.left = Math.random() * 100 + '%';
    emoji.style.fontSize = Math.random() * 20 + 20 + 'px';
    
    document.body.appendChild(emoji);
    
    setTimeout(() => {
        emoji.remove();
    }, 2000);
}

// === نظام الخريطة التفاعلية ===

function createStagesMap() {
    const mapContainer = document.getElementById('stages-map');
    if (!mapContainer) return;
    
    mapContainer.innerHTML = '';
    
    stagesData.forEach((stage, index) => {
        const stagePoint = document.createElement('div');
        stagePoint.className = 'stage-point';
        stagePoint.style.left = `${stage.position.x}%`;
        stagePoint.style.top = `${stage.position.y}%`;
        stagePoint.dataset.stage = stage.id;
        
        // إضافة خطوط الاتصال بين المراحل
        if (index > 0) {
            const prevStage = stagesData[index - 1];
            createConnectionLine(prevStage.position, stage.position);
        }
        
        const icon = document.createElement('i');
        icon.className = getStageIcon(stage.id);
        
        const number = document.createElement('span');
        number.textContent = stage.id;
        number.style.fontSize = '14px';
        number.style.fontWeight = 'bold';
        
        stagePoint.appendChild(icon);
        stagePoint.appendChild(number);
        
        // Tooltip للمعلومات الإضافية
        stagePoint.title = `${stage.title}\n${stage.description}`;
        
        // التحقق من حالة المرحلة
        updateStageStatus(stagePoint, stage);
        
        stagePoint.addEventListener('click', () => {
            if (!stagePoint.classList.contains('locked')) {
                vibrate();
                audioSystem.play('click');
                
                // تأثير عند النقر
                const rect = stagePoint.getBoundingClientRect();
                createMagicDust(rect.left + rect.width / 2, rect.top + rect.height / 2);
                
                showLevelsScreen(stage.id);
            } else {
                vibrate(100);
                audioSystem.play('error');
                showToast(`هذه المرحلة مقفلة. تحتاج ${stage.requiredPoints} نقطة للدخول`);
            }
        });
        
        // تأثير hover باستخدام GSAP
        stagePoint.addEventListener('mouseenter', () => {
            if (!stagePoint.classList.contains('locked')) {
                gsap.to(stagePoint, {
                    scale: 1.15,
                    duration: 0.3,
                    ease: "back.out(1.7)"
                });
            }
        });
        
        stagePoint.addEventListener('mouseleave', () => {
            gsap.to(stagePoint, {
                scale: 1,
                duration: 0.3,
                ease: "power2.out"
            });
        });
        
        mapContainer.appendChild(stagePoint);
    });
}

function createConnectionLine(start, end) {
    const line = document.createElement('div');
    line.className = 'stage-connection';
    
    const dx = end.x - start.x;
    const dy = end.y - start.y;
    const length = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx) * (180 / Math.PI);
    
    line.style.width = `${length}%`;
    line.style.left = `${start.x}%`;
    line.style.top = `${start.y}%`;
    line.style.transform = `rotate(${angle}deg)`;
    line.style.transformOrigin = '0 0';
    line.style.height = '2px';
    line.style.background = 'rgba(255, 255, 255, 0.2)';
    line.style.position = 'absolute';
    line.style.zIndex = '1';
    
    document.getElementById('stages-map').appendChild(line);
}

function getStageIcon(stageId) {
    const icons = ['fa-seedling', 'fa-mountain', 'fa-tree', 'fa-fort-awesome', 'fa-crown'];
    return `fas ${icons[stageId - 1] || 'fa-map-marker'}`;
}

function updateStageStatus(stagePoint, stage) {
    // التحقق من حالة المرحلة
    if (stage.id === 1) {
        stagePoint.classList.add('available');
    } else if (totalPoints >= stage.requiredPoints) {
        stagePoint.classList.add('available');
    } else {
        stagePoint.classList.add('locked');
    }
    
    // التحقق من الإنجاز
    const transaction = db ? db.transaction(['stages'], 'readonly') : null;
    if (transaction) {
        const stagesStore = transaction.objectStore('stages');
        const request = stagesStore.get(stage.id);
        
        request.onsuccess = (event) => {
            if (request.result && request.result.completed) {
                stagePoint.classList.remove('available');
                stagePoint.classList.add('completed');
            }
        };
    }
}

// === الانتقالات المتحركة ===

function transitionToScreen(targetScreenId, direction = 'left') {
    const currentScreen = document.querySelector('.screen.active');
    const targetScreen = document.getElementById(targetScreenId);
    
    if (!currentScreen || !targetScreen || currentScreen === targetScreen) return;
    
    // إعداد اتجاهات الانتقال
    const directions = {
        left: { current: 'slide-left', target: 'slide-right' },
        right: { current: 'slide-right', target: 'slide-left' },
        fade: { current: 'fade-out', target: 'fade-in' }
    };
    
    const transition = directions[direction] || directions.left;
    
    // إضافة فئات الانتقال
    currentScreen.classList.add(transition.current);
    targetScreen.classList.add(transition.target);
    
    setTimeout(() => {
        currentScreen.classList.remove('active', transition.current);
        targetScreen.classList.remove(transition.target);
        targetScreen.classList.add('active');
        
        // تشغيل تأثير عند الدخول
        if (targetScreenId === 'game-screen') {
            const cards = targetScreen.querySelectorAll('.card');
            if (cards.length > 0) {
                gsap.from(cards, {
                    y: 50,
                    opacity: 0,
                    stagger: 0.1,
                    duration: 0.5,
                    ease: "back.out(1.7)"
                });
            }
        }
        
        // تشغيل صوت الانتقال
        audioSystem.play('click');
    }, 500);
}

function getTransitionDirection(targetScreen) {
    const screens = ['stages-screen', 'levels-screen', 'game-screen', 'profile-screen', 'settings-screen'];
    const currentScreen = document.querySelector('.screen.active').id;
    
    const currentIndex = screens.indexOf(currentScreen);
    const targetIndex = screens.indexOf(targetScreen);
    
    if (currentIndex < targetIndex) {
        return 'left';
    } else if (currentIndex > targetIndex) {
        return 'right';
    }
    return 'fade';
}

// === تحسينات التفاعل مع البطاقات ===

function enhanceCardsInteraction() {
    document.addEventListener('mouseover', (e) => {
        if (e.target.closest('.card') && !e.target.closest('.card').classList.contains('flipped')) {
            const card = e.target.closest('.card');
            gsap.to(card, {
                y: -10,
                rotationY: 5,
                duration: 0.3,
                ease: "power2.out"
            });
        }
    });
    
    document.addEventListener('mouseout', (e) => {
        if (e.target.closest('.card')) {
            const card = e.target.closest('.card');
            gsap.to(card, {
                y: 0,
                rotationY: 0,
                duration: 0.3,
                ease: "power2.out"
            });
        }
    });
}

// === التأثيرات الخاصة بالفوز ===

function showVictoryEffects() {
    // تشغيل سلسلة من الأصوات للفوز
    audioSystem.playSequence(['win', 'star', 'levelComplete', 'applause']);
    
    // تأثير Confetti
    createEnhancedConfetti();
    
    // تأثير اهتزاز الشاشة
    gsap.to('body', {
        y: -10,
        duration: 0.1,
        repeat: 5,
        yoyo: true,
        ease: "power1.inOut"
    });
    
    // تأثير النجمة المتلألئة
    const stars = ['⭐', '🌟', '✨', '💫'];
    for (let i = 0; i < 10; i++) {
        setTimeout(() => {
            const star = document.createElement('div');
            star.className = 'floating-star';
            star.textContent = stars[Math.floor(Math.random() * stars.length)];
            star.style.position = 'fixed';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.fontSize = Math.random() * 30 + 20 + 'px';
            star.style.opacity = '0';
            star.style.zIndex = '9999';
            
            document.body.appendChild(star);
            
            gsap.to(star, {
                opacity: 1,
                scale: 1.5,
                rotation: 360,
                duration: 1,
                ease: "power2.out",
                onComplete: () => {
                    gsap.to(star, {
                        opacity: 0,
                        scale: 0.5,
                        duration: 0.5,
                        delay: 0.5,
                        onComplete: () => star.remove()
                    });
                }
            });
        }, i * 100);
    }
}

// === التمرير السلس ===

function setupSmoothScrolling() {
    const scrollToTopBtn = document.getElementById('scroll-to-top');
    if (!scrollToTopBtn) return;
    
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollToTopBtn.classList.add('show');
        } else {
            scrollToTopBtn.classList.remove('show');
        }
    });
    
    scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        audioSystem.play('click');
    });
}

// === دوال الصوت والاهتزاز ===

function vibrate(duration = 50) {
    if (window.vibrationEnabled && navigator.vibrate) {
        navigator.vibrate(duration);
    }
}

function playSound(type) {
    // استخدام نظام الصوت الجديد
    audioSystem.play(type);
}

// === الدوال الأساسية للتطبيق ===

function initApp() {
    // تهيئة نظام الصوت
    audioSystem.init();
    
    // إخفاء شاشة التحميل
    setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                // تشغيل موسيقى الخلفية بعد تحميل اللعبة
                setTimeout(() => {
                    audioSystem.playBackgroundMusic();
                }, 500);
            }, 500);
        }
    }, 1500);
    
    createStars();
    initializeDB();
    loadCulturalPuzzles();
    setupEventListeners();
    checkFirstTime();
    setupServiceWorker();
    startPlayTimer();
    checkInstallPrompt();
    showScreen('stages-screen');
    
    // تحميل الشاشات المنفصلة
    loadProfileScreen();
    loadSettingsScreen();
    
    // تهيئة الأنظمة الجديدة
    mascotSystem = new MascotSystem();
    createStagesMap();
    setupSmoothScrolling();
    enhanceCardsInteraction();
    
    // عرض رسالة ترحيبية من المرشد
    setTimeout(() => {
        if (mascotSystem) mascotSystem.showMessage();
    }, 2000);
    
    // إضافة مستمعين للأحداث الجديدة
    const mascot = document.getElementById('mascot');
    const mascotClose = document.getElementById('mascot-close');
    
    if (mascot) {
        mascot.addEventListener('click', (e) => {
            e.stopPropagation();
            if (mascotSystem) mascotSystem.showMessage();
        });
    }
    
    if (mascotClose) {
        mascotClose.addEventListener('click', (e) => {
            e.stopPropagation();
            if (mascotSystem) mascotSystem.hideMessage();
        });
    }
    
    // إغلاق حوار المرشد عند النقر خارجها
    document.addEventListener('click', (e) => {
        if (mascotSystem) {
            if (!e.target.closest('.mascot') && !e.target.closest('.mascot-dialog')) {
                mascotSystem.hideMessage();
            }
        }
    });
    
    // تعديل مستمعي الأحداث للبطاقات لإضافة تأثير الغبار
    document.addEventListener('click', (e) => {
        if (e.target.closest('.card') || e.target.closest('.player-card')) {
            createMagicDust(e.clientX, e.clientY);
        }
    });
}

function createStars() {
    const starsCount = 50;
    const container = document.body;
    
    for (let i = 0; i < starsCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        
        const size = Math.random() * 3 + 1;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        
        star.style.animationDuration = `${Math.random() * 4 + 2}s`;
        star.style.animationDelay = `${Math.random() * 3}s`;
        
        star.style.background = `rgba(255, 255, 255, ${Math.random() * 0.8 + 0.2})`;
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.5)`;
        
        container.appendChild(star);
    }
}

// تحميل شاشة الملف الشخصي
function loadProfileScreen() {
    fetch('profile.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById('profile-screen-container').innerHTML = html;
            // تهيئة شاشة الملف الشخصي
            if (typeof initProfileScreen === 'function') {
                initProfileScreen();
            }
        })
        .catch(error => {
            console.error('Error loading profile screen:', error);
        });
}

// تحميل شاشة الإعدادات
function loadSettingsScreen() {
    fetch('settings.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById('settings-screen-container').innerHTML = html;
            // تهيئة شاشة الإعدادات
            if (typeof initSettingsScreen === 'function') {
                initSettingsScreen();
            }
        })
        .catch(error => {
            console.error('Error loading settings screen:', error);
        });
}

// === قاعدة البيانات ===

function initializeDB() {
    const request = indexedDB.open('CardGameDB', 10); // زيادة الإصدار إلى 10

    request.onerror = (event) => {
        console.error('فشل في فتح قاعدة البيانات', event);
        showToast('خطأ في تحميل البيانات، يرجاء إعادة تحميل التطبيق');
    };

    request.onsuccess = (event) => {
        db = event.target.result;
        loadGameData();
    };

    request.onupgradeneeded = (event) => {
        db = event.target.result;
        const oldVersion = event.oldVersion;

        // إنشاء مخزن للمستويات
        if (!db.objectStoreNames.contains('levels')) {
            const levelsStore = db.createObjectStore('levels', { keyPath: 'id' });
            levelsStore.createIndex('completed', 'completed', { unique: false });
            levelsStore.createIndex('points', 'points', { unique: false });
            levelsStore.createIndex('stage', 'stage', { unique: false });
        }

        // إنشاء مخزن للإحصائيات
        if (!db.objectStoreNames.contains('stats')) {
            const statsStore = db.createObjectStore('stats', { keyPath: 'id' });
            statsStore.add({ id: 'puzzlesSolved', value: 0 });
            statsStore.add({ id: 'totalPoints', value: 0 });
        }

        // إنشاء مخزن للإعدادات
        if (!db.objectStoreNames.contains('settings')) {
            const settingsStore = db.createObjectStore('settings', { keyPath: 'id' });
            settingsStore.add({ id: 'vibration', value: true });
            settingsStore.add({ id: 'sound', value: true });
            settingsStore.add({ id: 'notifications', value: true });
            settingsStore.add({ id: 'volume', value: 0.7 }); // إضافة إعداد الصوت
        }

        // إنشاء مخزن للمستخدم
        if (!db.objectStoreNames.contains('user')) {
            const userStore = db.createObjectStore('user', { keyPath: 'id' });
            userStore.add({ 
                id: 'profile', 
                name: 'المستخدم',
                email: '',
                playTime: 0,
                totalPoints: 0,
                completedLevels: 0,
                currentStage: 1
            });
        }
        
        // إضافة مخزن جديد للصور
        if (!db.objectStoreNames.contains('images')) {
            db.createObjectStore('images', { keyPath: 'path' });
        }
        
        // إضافة مخزن للإنجازات
        if (!db.objectStoreNames.contains('achievements')) {
            const achievementsStore = db.createObjectStore('achievements', { keyPath: 'id' });
            // سيتم تحميل الإنجازات من ملف profile.js
        }
        
        // إضافة مخزن للتحدي اليومي
        if (!db.objectStoreNames.contains('dailyChallenge')) {
            db.createObjectStore('dailyChallenge', { keyPath: 'date' });
        }
        
        // إضافة مخزن للمراحل
        if (!db.objectStoreNames.contains('stages')) {
            const stagesStore = db.createObjectStore('stages', { keyPath: 'id' });
            stagesData.forEach(stage => {
                stagesStore.add({
                    id: stage.id,
                    title: stage.title,
                    completed: false,
                    completedLevels: 0,
                    totalLevels: stage.levels
                });
            });
        }
        
        // إضافة مخزن لتحديات الوقت
        if (!db.objectStoreNames.contains('timedChallenges')) {
            db.createObjectStore('timedChallenges', { keyPath: 'id' });
        }
    };
}

function loadGameData() {
    if (!db) return;
    
    const transaction = db.transaction(['stats', 'settings', 'user', 'achievements', 'stages'], 'readonly');
    const statsStore = transaction.objectStore('stats');
    const settingsStore = transaction.objectStore('settings');
    const userStore = transaction.objectStore('user');
    const achievementsStore = transaction.objectStore('achievements');
    
    const pointsRequest = statsStore.get('totalPoints');
    pointsRequest.onsuccess = (event) => {
        if (pointsRequest.result) {
            totalPoints = pointsRequest.result.value;
            document.getElementById('total-points').textContent = totalPoints;
            updateProgress('total-progress', totalPoints, getMaxPoints());
            updateTotalPointsInUI();
        }
    };
    
    const vibrationRequest = settingsStore.get('vibration');
    vibrationRequest.onsuccess = (event) => {
        if (vibrationRequest.result) {
            window.vibrationEnabled = vibrationRequest.result.value;
        }
    };
    
    const soundRequest = settingsStore.get('sound');
    soundRequest.onsuccess = (event) => {
        if (soundRequest.result) {
            window.soundEnabled = soundRequest.result.value;
            audioSystem.isEnabled = soundRequest.result.value;
        }
    };
    
    const volumeRequest = settingsStore.get('volume');
    volumeRequest.onsuccess = (event) => {
        if (volumeRequest.result) {
            audioSystem.setVolume(volumeRequest.result.value);
        }
    };
    
    const notificationsRequest = settingsStore.get('notifications');
    notificationsRequest.onsuccess = (event) => {
        if (notificationsRequest.result) {
            window.notificationsEnabled = notificationsRequest.result.value;
        }
    };
    
    const userRequest = userStore.get('profile');
    userRequest.onsuccess = (event) => {
        if (userRequest.result) {
            userName = userRequest.result.name;
            userEmail = userRequest.result.email;
            playTime = userRequest.result.playTime || 0;
            currentStage = userRequest.result.currentStage || 1;
        }
    };
    
    loadStages();
}

// === اللعبة الأساسية ===

async function loadCulturalPuzzles() {
    try {
        const response = await fetch('cultural-puzzles.json');
        const data = await response.json();
        culturalPuzzles = data.puzzles;
        console.log('تم تحميل الألغاز الثقافية بنجاح');
    } catch (error) {
        console.error('فشل في تحميل الألغاز الثقافية:', error);
        culturalPuzzles = [
            {
                id: 1,
                question: "ما هي عاصمة المملكة العربية السعودية؟",
                options: ["الرياض", "جدة", "مكة", "الدمام"],
                correctAnswer: 0,
                category: "جغرافيا"
            },
            {
                id: 2,
                question: "من هو مؤلف كتاب 'ديوان المتنبي'؟",
                options: ["أبو تمام", "المتنبي", "أبو فراس الحمداني", "البحتري"],
                correctAnswer: 1,
                category: "أدب"
            },
            {
                id: 3,
                question: "ما هو أطول نهر في العالم؟",
                options: ["نهر النيل", "نهر الأمازون", "نهر المسيسيبي", "نهر اليانغتسي"],
                correctAnswer: 0,
                category: "جغرافيا"
            },
            {
                id: 4,
                question: "من هو صاحب لوحة الموناليزا؟",
                options: ["ليوناردو دافنشي", "بابلو بيكاسو", "فان جوخ", "ميكيلانجيلو"],
                correctAnswer: 0,
                category: "فن"
            },
            {
                id: 5,
                question: "ما هي اللغة الرسمية في البرازيل؟",
                options: ["البرتغالية", "الإسبانية", "الإنجليزية", "الفرنسية"],
                correctAnswer: 0,
                category: "ثقافة عامة"
            }
        ];
    }
}

function showLevelsScreen(stageId) {
    currentStage = stageId;
    const stageData = stagesData.find(s => s.id === stageId);
    
    if (stageData) {
        document.getElementById('stage-title').textContent = stageData.title;
    }
    
    transitionToScreen('levels-screen', 'left');
    loadLevels(stageId);
}

function loadLevels(stageId) {
    const levelsContainer = document.getElementById('levels-container');
    if (!levelsContainer) return;
    
    levelsContainer.innerHTML = '';
    
    const stageLevels = levelsData.filter(level => level.stage === stageId);
    const stagePoints = stageLevels.reduce((acc, level) => {
        return acc + (level.completed ? level.points : 0);
    }, 0);
    
    document.getElementById('stage-points').textContent = stagePoints;
    updateProgress('stage-progress', stagePoints, stageLevels.length * 3);
    
    const transaction = db ? db.transaction(['levels'], 'readonly') : null;
    if (!transaction) return;
    
    const levelsStore = transaction.objectStore('levels');
    
    stageLevels.forEach(levelData => {
        const levelCard = document.createElement('div');
        levelCard.className = 'level-card ripple glass-effect';
        levelCard.dataset.level = levelData.id;
        
        const levelBg = document.createElement('div');
        levelBg.className = 'level-bg';
        levelBg.style.backgroundImage = `url(${levelData.background})`;
        levelCard.appendChild(levelBg);
        
        const levelNumber = document.createElement('div');
        levelNumber.className = 'level-number';
        levelNumber.innerHTML = `<i class="fas fa-${levelData.id === 1 ? 'play' : 'hashtag'}"></i> ${levelData.level}`;
        levelCard.appendChild(levelNumber);
        
        const levelStatus = document.createElement('div');
        levelStatus.className = 'level-status';
        levelCard.appendChild(levelStatus);
        
        if (levelData.level % 5 === 0) {
            const ribbon = document.createElement('div');
            ribbon.className = 'ribbon';
            ribbon.innerHTML = '<span>مميز</span>';
            levelCard.appendChild(ribbon);
        }
        
        const request = levelsStore.get(levelData.id);
        
        request.onsuccess = (event) => {
            if (request.result) {
                if (request.result.completed) {
                    levelCard.classList.add('completed');
                    levelStatus.innerHTML = `<i class="fas fa-star"></i> ${request.result.points}/3`;
                }
            }
            
            if (levelData.id > 1) {
                if (totalPoints < levelData.requiredPoints) {
                    levelCard.classList.add('locked');
                    levelStatus.innerHTML = `<i class="fas fa-lock"></i> ${levelData.requiredPoints} نقطة`;
                } else {
                    const prevRequest = levelsStore.get(levelData.id-1);
                    prevRequest.onsuccess = (e) => {
                        if (!prevRequest.result || !prevRequest.result.completed) {
                            levelCard.classList.add('locked');
                            levelStatus.innerHTML = '<i class="fas fa-lock"></i> مقفل';
                        }
                    };
                }
            }
        };
        
        levelCard.addEventListener('click', () => {
            if (!levelCard.classList.contains('locked')) {
                vibrate();
                audioSystem.play('click');
                startLevel(levelData.id);
            } else {
                vibrate(100);
                audioSystem.play('error');
                showToast('هذا المستوى مقفل، يجب إكمال المستوى السابق أولاً');
            }
        });
        
        levelsContainer.appendChild(levelCard);
    });
    
    updateTotalPointsInUI();
}

function startLevel(levelId) {
    currentLevel = levelId;
    levelPoints = 0;
    
    const levelData = levelsData.find(l => l.id === levelId);
    if (!levelData) return;
    
    currentStage = levelData.stage;
    
    showCulturalPuzzleBeforeLevel(levelData);
}

function showCulturalPuzzleBeforeLevel(levelData) {
    if (culturalPuzzles.length === 0) {
        setupGameScreen(levelData);
        return;
    }
    
    // تشغيل صوت اللغز الثقافي
    audioSystem.play('culturalPuzzle');
    
    const randomIndex = Math.floor(Math.random() * culturalPuzzles.length);
    const puzzle = culturalPuzzles[randomIndex];
    
    const puzzleHTML = `
        <div class="cultural-puzzle-overlay active" id="cultural-puzzle-before-level">
            <div class="cultural-puzzle-container glass-effect">
                <div class="puzzle-header">
                    <h2>لغز ثقافي</h2>
                    <span class="puzzle-category">${puzzle.category}</span>
                    <p class="puzzle-instruction">حل هذا اللغز لبدء المستوى!</p>
                </div>
                <div class="puzzle-question">${puzzle.question}</div>
                <div class="puzzle-options">
                    ${puzzle.options.map((option, index) => `
                        <button class="puzzle-option glass-effect-light" data-index="${index}">${option}</button>
                    `).join('')}
                </div>
                <div class="puzzle-result" id="puzzle-before-result"></div>
                <button class="btn puzzle-continue-btn" id="puzzle-continue-btn" style="display: none;">متابعة إلى اللعبة</button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', puzzleHTML);
    
    document.querySelectorAll('#cultural-puzzle-before-level .puzzle-option').forEach(option => {
        option.addEventListener('click', function() {
            const selectedIndex = parseInt(this.dataset.index);
            const resultElement = document.getElementById('puzzle-before-result');
            const continueBtn = document.getElementById('puzzle-continue-btn');
            
            document.querySelectorAll('#cultural-puzzle-before-level .puzzle-option').forEach(opt => {
                opt.disabled = true;
            });
            
            if (selectedIndex === puzzle.correctAnswer) {
                resultElement.innerHTML = '<i class="fas fa-check-circle"></i> إجابة صحيحة! لقد ربحت نقطة إضافية.';
                resultElement.className = 'puzzle-result correct';
                
                audioSystem.play('success');
                
                totalPoints++;
                updatePointsInDatabase();
                showToast('لقد ربحت نقطة إضافية لإجابتك الصحيحة!');
                
            } else {
                resultElement.innerHTML = '<i class="fas fa-times-circle"></i> إجابة خاطئة. حاول في المرة القادمة!';
                resultElement.className = 'puzzle-result incorrect';
                this.classList.add('incorrect');
                
                audioSystem.play('error');
                vibrate(200);
            }
            
            continueBtn.style.display = 'block';
        });
    });
    
    document.getElementById('puzzle-continue-btn').addEventListener('click', function() {
        audioSystem.play('click');
        document.getElementById('cultural-puzzle-before-level').remove();
        setupGameScreen(levelData);
    });
}

function setupGameScreen(levelData) {
    transitionToScreen('game-screen', 'left');
    document.getElementById('current-stage').textContent = currentStage;
    document.getElementById('current-level').textContent = levelData.level;
    document.getElementById('level-points').textContent = '0';
    updateProgress('level-progress', 0, 3);
    
    if (gameMode === "timed") {
        timeLeft = 60;
        document.getElementById('timer-container').style.display = 'flex';
        document.getElementById('timer').textContent = timeLeft;
        startGameTimer();
    } else {
        document.getElementById('timer-container').style.display = 'none';
        if (gameTimer) {
            clearInterval(gameTimer);
            gameTimer = null;
        }
    }
    
    document.getElementById('hint-text').style.display = 'none';
    document.getElementById('hint-cost').textContent = hintCost;
    
    createCards(levelData.id);
}

function createCards(levelId) {
    const appCardsContainer = document.getElementById('app-cards');
    const playerCardsContainer = document.getElementById('player-cards');
    
    if (!appCardsContainer || !playerCardsContainer) return;
    
    appCardsContainer.innerHTML = '';
    playerCardsContainer.innerHTML = '';
    
    const levelData = levelsData.find(l => l.id === levelId);
    if (!levelData) return;
    
    const puzzleCards = levelData.cards.filter(card => card.type === 'puzzle');
    const solutionCards = levelData.cards.filter(card => card.type === 'solution');
    
    shuffleArray(solutionCards);
    
    puzzleCards.forEach(card => {
        const cardElement = createAppCardElement(card);
        appCardsContainer.appendChild(cardElement);
    });
    
    solutionCards.forEach(card => {
        const cardElement = createPlayerCardElement(card);
        playerCardsContainer.appendChild(cardElement);
    });
    
    lazyLoadImages();
}

function createAppCardElement(cardData) {
    const card = document.createElement('div');
    card.className = 'card ripple';
    card.dataset.id = cardData.id;
    
    const cardInner = document.createElement('div');
    cardInner.className = 'card-inner';
    
    const cardFront = document.createElement('div');
    cardFront.className = 'card-front';
    
    const cardImage = document.createElement('img');
    cardImage.className = 'card-image loading';
    cardImage.dataset.src = cardData.path;
    cardImage.alt = 'لغز';
    cardFront.appendChild(cardImage);
    
    const cardBack = document.createElement('div');
    cardBack.className = 'card-back';
    
    if (gameMode === "daily") {
        cardBack.style.background = "linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)";
        cardBack.innerHTML = '<div class="pattern daily">☀️</div><div>تحدي اليوم</div>';
    } else if (gameMode === "timed") {
        cardBack.style.background = "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
        cardBack.innerHTML = '<div class="pattern timed">⏱️</div><div>تحدي الوقت</div>';
    } else {
        cardBack.innerHTML = '<div class="pattern">❖</div><div>؟</div>';
    }
    
    cardInner.appendChild(cardFront);
    cardInner.appendChild(cardBack);
    card.appendChild(cardInner);
    
    // تأثير GSAP للظهور
    gsap.set(card, { opacity: 0, y: 50 });
    
    card.addEventListener('click', () => {
        if (!selectedCard) {
            showPuzzleCard(card);
            gsap.to(card.querySelector('.card-inner'), {
                rotationY: 180,
                duration: 0.6,
                ease: "power2.inOut"
            });
        }
    });
    
    setTimeout(() => {
        gsap.to(card, {
            opacity: 1,
            y: 0,
            duration: 0.5,
            ease: "back.out(1.7)"
        });
    }, Math.random() * 300);
    
    return card;
}

function createPlayerCardElement(cardData) {
    const card = document.createElement('div');
    card.className = 'player-card ripple';
    card.dataset.id = cardData.id;
    
    if (gameMode === "daily") {
        card.classList.add('daily-card');
    } else if (gameMode === "timed") {
        card.classList.add('timed-card');
    }
    
    const cardImage = document.createElement('img');
    cardImage.className = 'card-image loading';
    cardImage.dataset.src = cardData.path;
    cardImage.alt = 'حل';
    card.appendChild(cardImage);
    
    // تأثير GSAP للظهور
    gsap.set(card, { opacity: 0, y: 50 });
    
    card.addEventListener('click', () => {
        selectCard(card);
    });
    
    setTimeout(() => {
        gsap.to(card, {
            opacity: 1,
            y: 0,
            duration: 0.5,
            ease: "back.out(1.7)"
        });
    }, Math.random() * 300);
    
    return card;
}

function showPuzzleCard(card) {
    if (selectedCard) return;
    
    card.classList.add('flipped');
    selectedCard = card;
    audioSystem.play('flip');
    
    setTimeout(() => {
        if (card.classList.contains('flipped')) {
            card.classList.remove('flipped');
            selectedCard = null;
        }
    }, 3000);
}

function selectCard(card) {
    if (!selectedCard) {
        showMessage('تنبيه', `${userName}، الرجاء النقر على إحدى بطاقات اللغز أولاً`);
        vibrate(100);
        return;
    }
    
    if (selectedCard.dataset.id === card.dataset.id) {
        selectedCard.style.visibility = 'hidden';
        selectedCard = null;
        
        levelPoints++;
        document.getElementById('level-points').textContent = levelPoints;
        updateProgress('level-progress', levelPoints, 3);
        
        audioSystem.play('success');
        vibrate(50);
        
        if (levelPoints === 3) {
            completeLevel();
        } else {
            audioSystem.play('star');
            showToast(`إجابة صحيحة! ${userName}، لقد كسبت نقطة`);
        }
    } else {
        audioSystem.play('error');
        vibrate(200);
        
        if (totalPoints > 0) {
            totalPoints--;
            updatePointsInDatabase();
            audioSystem.play('coin');
            showToast('تم خصم نقطة بسبب الإجابة الخاطئة');
        }
        
        showMessage('إجابة خاطئة', `${userName}، حاول مرة أخرى`);
        selectedCard.classList.remove('flipped');
        selectedCard = null;
    }
}

function completeLevel() {
    const transaction = db.transaction(['levels', 'stats', 'user', 'stages'], 'readwrite');
    
    const levelsStore = transaction.objectStore('levels');
    levelsStore.put({
        id: currentLevel,
        completed: true,
        points: levelPoints,
        stage: currentStage
    });
    
    totalPoints += levelPoints;
    const statsStore = transaction.objectStore('stats');
    statsStore.put({
        id: 'totalPoints',
        value: totalPoints
    });
    
    const stagesStore = transaction.objectStore('stages');
    const stageRequest = stagesStore.get(currentStage);
    
    stageRequest.onsuccess = (event) => {
        const stage = event.target.result;
        
        const levelsInStage = levelsData.filter(l => l.stage === currentStage);
        const completedLevelsInStage = levelsInStage.filter(l => l.completed).length + 1;
        
        stage.completedLevels = completedLevelsInStage;
        
        if (completedLevelsInStage === levelsInStage.length) {
            stage.completed = true;
            
            if (currentStage < stagesData.length) {
                const nextStage = stagesData.find(s => s.id === currentStage + 1);
                const nextStageRequest = stagesStore.get(nextStage.id);
                
                nextStageRequest.onsuccess = (e) => {
                    const nextStageData = e.target.result;
                    nextStageData.completed = false;
                    stagesStore.put(nextStageData);
                };
            }
        }
        
        stagesStore.put(stage);
    };
    
    transaction.oncomplete = () => {
        if (gameTimer) {
            clearInterval(gameTimer);
            gameTimer = null;
        }
        
        showVictoryEffects();
        
        showMessage('تهانينا!', `${userName}، لقد أكملت المستوى ${currentLevel} بنجاح`, true);
        
        document.getElementById('total-points').textContent = totalPoints;
        updateProgress('total-progress', totalPoints, getMaxPoints());
        updateTotalPointsInUI();
        
        // تحديث إحصائيات الملف الشخصي
        if (typeof updateProfileStats === 'function') {
            updateProfileStats();
        }
        
        setTimeout(() => {
            if (gameMode === "daily" || gameMode === "timed") {
                showScreen('stages-screen');
            } else {
                showLevelsScreen(currentStage);
            }
        }, 2000);
        
        if (currentLevel % 5 === 0) {
            audioSystem.play('achievement');
            showAchievement(`مبارك ${userName}! لقد وصلت إلى المستوى ${currentLevel}!`);
        }
        
        if (gameMode === "timed" && timeLeft >= 30) {
            // التحقق من إنجاز speed_runner
            if (typeof unlockAchievement === 'function') {
                unlockAchievement("speed_runner");
                audioSystem.play('achievement');
            }
        }
        
        if (gameMode === "daily") {
            // التحقق من إنجاز daily_challenge
            if (typeof unlockAchievement === 'function') {
                unlockAchievement("daily_challenge");
                audioSystem.play('achievement');
            }
        }
        
        // رسالة من المرشد
        setTimeout(() => {
            if (mascotSystem) {
                mascotSystem.showMessage('أحسنت! مستواك يتحسن باستمرار. تابع التقدم!');
            }
        }, 1000);
    };
}

// === الدوال المساعدة ===

function updatePointsInDatabase() {
    if (!db) return;
    
    const transaction = db.transaction(['stats'], 'readwrite');
    const statsStore = transaction.objectStore('stats');
    statsStore.put({
        id: 'totalPoints',
        value: totalPoints
    });
    
    document.getElementById('total-points').textContent = totalPoints;
    updateProgress('total-progress', totalPoints, getMaxPoints());
    updateTotalPointsInUI();
}

function getMaxPoints() {
    return levelsData.length * 3;
}

function updateTotalPointsInUI() {
    const elements = [
        'total-points-stages',
        'total-points-levels'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = totalPoints;
        }
    });
}

function updateProgress(progressBarId, current, max) {
    const progressBar = document.getElementById(progressBarId);
    if (progressBar) {
        const percentage = (current / max) * 100;
        progressBar.style.width = `${percentage}%`;
    }
}

function showScreen(screenId) {
    const direction = getTransitionDirection(screenId);
    transitionToScreen(screenId, direction);
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    const activeNavItem = document.querySelector(`.nav-item[data-target="${screenId}"]`);
    if (activeNavItem) {
        activeNavItem.classList.add('active');
    }
    
    if (screenId === 'profile-screen') {
        // تحديث إحصائيات الملف الشخصي
        if (typeof updateProfileStats === 'function') {
            updateProfileStats();
        }
    } else if (screenId === 'stages-screen') {
        createStagesMap();
    }
}

function showMessage(title, text, isLevelComplete = false) {
    const message = document.getElementById('message');
    const messageTitle = document.getElementById('message-title');
    const messageText = document.getElementById('message-text');
    const messageBtn = document.getElementById('message-btn');
    
    if (!message || !messageTitle || !messageText || !messageBtn) return;
    
    messageTitle.textContent = title;
    messageText.textContent = text;
    message.classList.add('show');
    
    audioSystem.play('notification');
    
    messageBtn.onclick = () => {
        message.classList.remove('show');
        audioSystem.play('click');
        
        if (isLevelComplete) {
            if (gameMode === "daily" || gameMode === "timed") {
                showScreen('stages-screen');
            } else {
                showLevelsScreen(currentStage);
            }
        }
    };
}

function showToast(message) {
    if (typeof Toastify === 'function') {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "center",
            backgroundColor: "linear-gradient(to right, #6c5ce7, #fd79a8)",
            stopOnFocus: true
        }).showToast();
    }
    audioSystem.play('notification');
}

function showAchievement(text) {
    if (!window.notificationsEnabled) return;
    
    const badge = document.createElement('div');
    badge.className = 'achievement-badge glass-effect';
    badge.innerHTML = `<i class="fas fa-trophy"></i> <span>${text}</span>`;
    
    document.body.appendChild(badge);
    
    setTimeout(() => {
        badge.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        badge.classList.remove('show');
        setTimeout(() => {
            badge.remove();
        }, 500);
    }, 3000);
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// === دوال النظام ===

function startPlayTimer() {
    playTimer = setInterval(() => {
        playTime++;
        if (document.getElementById('profile-screen')?.classList.contains('active')) {
            // تحديث إحصائيات الملف الشخصي
            if (typeof updateProfileStats === 'function') {
                updateProfileStats();
            }
        }
    }, 60000);
}

function startGameTimer() {
    if (gameTimer) clearInterval(gameTimer);
    
    gameTimer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        
        if (timeLeft <= 10) {
            document.getElementById('timer-container').classList.add('warning');
            if (timeLeft <= 5) {
                audioSystem.play('timer');
            }
        }
        
        if (timeLeft <= 0) {
            clearInterval(gameTimer);
            audioSystem.play('error');
            showMessage('انتهى الوقت', 'لقد انتهى الوقت المخصص لهذا المستوى');
            setTimeout(() => {
                if (gameMode === "daily" || gameMode === "timed") {
                    showScreen('stages-screen');
                } else {
                    showLevelsScreen(currentStage);
                }
            }, 2000);
        }
    }, 1000);
}

function setupServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(function(registration) {
            console.log('ServiceWorker registration successful');
        }).catch(function(err) {
            console.log('ServiceWorker registration failed: ', err);
        });
    }
}

function checkFirstTime() {
    if (!localStorage.getItem('firstTime')) {
        setTimeout(() => {
            showToast('مرحباً بك في أبطال البطاقات! استمتع باللعبة');
            localStorage.setItem('firstTime', 'false');
        }, 2000);
    }
}

function checkInstallPrompt() {
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        window.deferredPrompt = e;
        const installBtn = document.getElementById('install-app');
        if (installBtn) installBtn.style.display = 'inline-flex';
    });

    const installBtn = document.getElementById('install-app');
    if (installBtn) {
        installBtn.addEventListener('click', async () => {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                const { outcome } = await window.deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    audioSystem.play('success');
                } else {
                    console.log('User dismissed the install prompt');
                }
                window.deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        });
    }
}

function lazyLoadImages() {
    const images = document.querySelectorAll('.card-image');
    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const path = img.dataset.src;
                
                if (db) {
                    const transaction = db.transaction(['images'], 'readonly');
                    const imagesStore = transaction.objectStore('images');
                    const request = imagesStore.get(path);
                    
                    request.onsuccess = () => {
                        if (request.result) {
                            img.src = request.result.data;
                            img.classList.remove('loading');
                        } else {
                            fetchImageAndCache(path, img);
                        }
                    };
                }
                
                observer.unobserve(img);
            }
        });
    }, {
        rootMargin: "0px 0px 100px 0px"
    });

    images.forEach(img => {
        observer.observe(img);
    });
}

async function fetchImageAndCache(path, imgElement) {
    try {
        const response = await fetch(path);
        const blob = await response.blob();
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            const base64data = reader.result;
            
            if (db) {
                const transaction = db.transaction(['images'], 'readwrite');
                const imagesStore = transaction.objectStore('images');
                imagesStore.put({ path: path, data: base64data });
            }
            
            imgElement.src = base64data;
            imgElement.classList.remove('loading');
        };
    } catch (error) {
        console.error(`Failed to load image from network: ${path}`, error);
        imgElement.classList.remove('loading');
        imgElement.classList.add('error');
    }
}

// === إعداد مستمعي الأحداث ===

function setupEventListeners() {
    const backBtn = document.getElementById('back-to-levels-btn');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            audioSystem.play('click');
            vibrate();
            if (gameMode === "daily" || gameMode === "timed") {
                showScreen('stages-screen');
            } else {
                showLevelsScreen(currentStage);
            }
        });
    }
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            audioSystem.play('click');
            vibrate();
            
            const targetScreen = item.getAttribute('data-target');
            showScreen(targetScreen);
        });
    });
    
    const hintBtn = document.getElementById('hint-btn');
    if (hintBtn) {
        hintBtn.addEventListener('click', () => {
            useHint();
        });
    }
    
    document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            audioSystem.play('click');
            const mode = tab.getAttribute('data-mode');
            changeGameMode(mode);
        });
    });
    
    document.addEventListener('touchmove', function(e) {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    }, { passive: false });
    
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    // زر العودة إلى الخريطة
    const backToStagesBtn = document.getElementById('back-to-stages-btn');
    if (backToStagesBtn) {
        backToStagesBtn.addEventListener('click', () => {
            audioSystem.play('click');
            showScreen('stages-screen');
        });
    }
    
    // زر إعادة المحاولة
    const restartLevelBtn = document.getElementById('restart-level-btn');
    if (restartLevelBtn) {
        restartLevelBtn.addEventListener('click', () => {
            audioSystem.play('click');
            startLevel(currentLevel);
        });
    }
    
    // زر المستوى العشوائي
    const randomLevelBtn = document.getElementById('random-level-btn');
    if (randomLevelBtn) {
        randomLevelBtn.addEventListener('click', () => {
            audioSystem.play('click');
            const availableLevels = levelsData.filter(level => {
                return level.stage === currentStage && 
                       totalPoints >= level.requiredPoints;
            });
            
            if (availableLevels.length > 0) {
                const randomLevel = availableLevels[Math.floor(Math.random() * availableLevels.length)];
                startLevel(randomLevel.id);
            } else {
                showToast('لا توجد مستويات متاحة حالياً');
            }
        });
    }
    
    // إضافة زر التحكم في الصوت
    const soundToggleBtn = document.getElementById('sound-toggle');
    if (soundToggleBtn) {
        soundToggleBtn.addEventListener('click', () => {
            const isEnabled = audioSystem.toggleSound();
            const icon = soundToggleBtn.querySelector('i');
            if (isEnabled) {
                icon.className = 'fas fa-volume-up';
                showToast('تم تشغيل الصوت');
            } else {
                icon.className = 'fas fa-volume-mute';
                showToast('تم إيقاف الصوت');
            }
        });
    }
}

function changeGameMode(mode) {
    gameMode = mode;
    document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.mode-tab[data-mode="${mode}"]`).classList.add('active');
    
    if (mode === "normal") {
        loadLevels(currentStage);
    } else if (mode === "daily") {
        loadDailyChallenges();
    } else if (mode === "timed") {
        loadTimedChallenges();
    }
}

function loadDailyChallenges() {
    const levelsContainer = document.getElementById('levels-container');
    if (!levelsContainer) return;
    
    levelsContainer.innerHTML = '';
    
    dailyChallenges.forEach(challenge => {
        const challengeCard = document.createElement('div');
        challengeCard.className = 'level-card ripple daily-challenge glass-effect';
        challengeCard.dataset.id = challenge.id;
        
        const challengeBg = document.createElement('div');
        challengeBg.className = 'level-bg';
        challengeBg.style.backgroundImage = `url(${challenge.background})`;
        challengeCard.appendChild(challengeBg);
        
        const challengeNumber = document.createElement('div');
        challengeNumber.className = 'level-number';
        challengeNumber.innerHTML = `<i class="fas fa-calendar-day"></i> ${challenge.id}`;
        challengeCard.appendChild(challengeNumber);
        
        const challengeTitle = document.createElement('div');
        challengeTitle.className = 'challenge-title';
        challengeTitle.textContent = challenge.title;
        challengeCard.appendChild(challengeTitle);
        
        const challengeStatus = document.createElement('div');
        challengeStatus.className = 'level-status';
        challengeStatus.innerHTML = '<i class="fas fa-star"></i> 0/3';
        challengeCard.appendChild(challengeStatus);
        
        challengeCard.addEventListener('click', () => {
            vibrate();
            audioSystem.play('click');
            startDailyChallenge();
        });
        
        levelsContainer.appendChild(challengeCard);
    });
}

function loadTimedChallenges() {
    const levelsContainer = document.getElementById('levels-container');
    if (!levelsContainer) return;
    
    levelsContainer.innerHTML = '';
    
    timedChallenges.forEach(challenge => {
        const challengeCard = document.createElement('div');
        challengeCard.className = 'level-card ripple timed-challenge glass-effect';
        challengeCard.dataset.id = challenge.id;
        
        const challengeBg = document.createElement('div');
        challengeBg.className = 'level-bg';
        challengeBg.style.backgroundImage = `url(${challenge.background})`;
        challengeCard.appendChild(challengeBg);
        
        const challengeNumber = document.createElement('div');
        challengeNumber.className = 'level-number';
        challengeNumber.innerHTML = `<i class="fas fa-stopwatch"></i> ${challenge.id}`;
        challengeCard.appendChild(challengeNumber);
        
        const challengeTitle = document.createElement('div');
        challengeTitle.className = 'challenge-title';
        challengeTitle.textContent = challenge.title;
        challengeCard.appendChild(challengeTitle);
        
        const challengeTime = document.createElement('div');
        challengeTime.className = 'challenge-time';
        challengeTime.innerHTML = `<i class="fas fa-clock"></i> ${challenge.timeLimit} ثانية`;
        challengeCard.appendChild(challengeTime);
        
        const challengeStatus = document.createElement('div');
        challengeStatus.className = 'level-status';
        challengeStatus.innerHTML = '<i class="fas fa-star"></i> 0/3';
        challengeCard.appendChild(challengeStatus);
        
        challengeCard.addEventListener('click', () => {
            vibrate();
            audioSystem.play('click');
            startTimedChallenge();
        });
        
        levelsContainer.appendChild(challengeCard);
    });
}

function startDailyChallenge() {
    gameMode = "daily";
    const challenge = dailyChallenges[0];
    
    if (challenge) {
        showCulturalPuzzleBeforeLevel(challenge);
    }
}

function startTimedChallenge() {
    gameMode = "timed";
    const challenge = timedChallenges[0];
    
    if (challenge) {
        showCulturalPuzzleBeforeLevel(challenge);
    }
}

function useHint() {
    if (totalPoints < hintCost) {
        audioSystem.play('error');
        showToast(`ليس لديك نقاط كافية. تحتاج إلى ${hintCost} نقاط`);
        return;
    }
    
    if (!selectedCard) {
        showToast('الرجاء النقر على إحدى بطاقات اللغز أولاً');
        return;
    }
    
    totalPoints -= hintCost;
    updatePointsInDatabase();
    
    const hintText = document.getElementById('hint-text');
    if (hintText) {
        hintText.style.display = 'block';
        hintText.textContent = `البطاقة الصحيحة هي إحدى البطاقات الثلاث المتاحة. حاول التركيز على التفاصيل!`;
    }
    
    audioSystem.play('hint');
    showToast(`تم استخدام تلميح وخصم ${hintCost} نقاط`);
}

function loadStages() {
    if (!db) return;
    
    const transaction = db.transaction(['stages'], 'readonly');
    const stagesStore = transaction.objectStore('stages');
    
    stagesData.forEach(stage => {
        const request = stagesStore.get(stage.id);
        request.onsuccess = (event) => {
            if (!request.result) {
                // إضافة المرحلة إذا لم تكن موجودة
                const writeTransaction = db.transaction(['stages'], 'readwrite');
                const writeStore = writeTransaction.objectStore('stages');
                writeStore.add({
                    id: stage.id,
                    title: stage.title,
                    completed: false,
                    completedLevels: 0,
                    totalLevels: stage.levels
                });
            }
        };
    });
}

// تهيئة التطبيق عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', initApp);
</script>
    
    <!-- PWA Manifest -->
    <script type="application/json" id="manifest-data">
        {
            "name": "أبطال البطاقات",
            "short_name": "البطاقات",
            "description": "لعبة ذكاء مثيرة بتحديات متنوعة",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#1a1a2e",
            "theme_color": "#6c5ce7",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "icon-192.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "any maskable"
                },
                {
                    "src": "icon-512.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "any maskable"
                },
                {
                    "src": "icon-144.png",
                    "sizes": "144x144",
                    "type": "image/png"
                },
                {
                    "src": "icon-384.png",
                    "sizes": "384x384",
                    "type": "image/png"
                }
            ],
            "screenshots": [
                {
                    "src": "screenshot1.png",
                    "sizes": "1280x720",
                    "type": "image/png",
                    "form_factor": "wide"
                },
                {
                    "src": "screenshot2.png",
                    "sizes": "750x1334",
                    "type": "image/png",
                    "form_factor": "narrow"
                }
            ],
            "categories": ["games", "education", "puzzle"],
            "lang": "ar",
            "dir": "rtl",
            "prefer_related_applications": false
        }
    </script>
    
    <script>
        // إنشاء ملف Manifest ديناميكيًا
        document.addEventListener('DOMContentLoaded', function() {
            const manifestData = JSON.parse(document.getElementById('manifest-data').textContent);
            const blob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('link[rel="manifest"]').href = manifestURL;
            
            // إضافة وصف للصور
            document.querySelectorAll('img').forEach(img => {
                if (!img.hasAttribute('alt')) {
                    img.setAttribute('alt', 'صورة لعبة');
                }
            });
        });
        
        // تهيئة الوصول
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const dialogs = document.querySelectorAll('[role="dialog"]:not([aria-hidden="true"])');
                if (dialogs.length > 0) {
                    e.preventDefault();
                    dialogs.forEach(dialog => {
                        dialog.setAttribute('aria-hidden', 'true');
                        dialog.style.display = 'none';
                    });
                }
            }
        });
        
        // تحسين الوصول للشاشات الصغيرة
        if ('ontouchstart' in window || navigator.maxTouchPoints) {
            document.documentElement.classList.add('touch-device');
        } else {
            document.documentElement.classList.add('no-touch-device');
        }
        
        // تهيئة المتغيرات العامة
        window.vibrationEnabled = true;
        window.soundEnabled = true;
        window.notificationsEnabled = true;
        window.deferredPrompt = null;
    </script>
</body>
</html>
